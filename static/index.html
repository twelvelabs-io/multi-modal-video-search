<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TwelveLabs Marengo - Multi-Modal Video Search</title>
    <link rel="icon" type="image/x-icon" href="/static/images/TL-favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        (function() {
            var saved = localStorage.getItem('strand-dark-mode');
            var theme;
            if (saved !== null) {
                theme = saved === 'true' ? 'dark' : 'light';
            } else {
                theme = 'light';
            }
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
    <style>
        /* =============================================
           Strand Design System — CSS Custom Properties
           Source: packages/strand/tokens/colors.json
           ============================================= */
        :root,
        [data-theme="dark"] {
            /* Backgrounds */
            --bg-body: #1D1C1B;
            --bg-header: #2A2928;
            --bg-surface: #2A2928;
            --bg-surface-hover: #333231;
            --bg-input: #1D1C1B;
            --bg-deep: #1D1C1B;
            --bg-elevated: #333231;
            --bg-card: #333231;

            /* Borders */
            --border: #45423F;
            --border-light: #333231;
            --border-hover: #6B6966;
            --border-focus: #00DC82;

            /* Text */
            --text-primary: #F4F3F3;
            --text-secondary: #9B9895;
            --text-tertiary: #6B6966;
            --text-inverse: #1D1C1B;

            /* Accent — UI green (#00DC82), not brand green (#00FF00) */
            --accent: #00DC82;
            --accent-hover: #00B86E;
            --accent-light: #1A3D2A;
            --accent-muted: rgba(0, 220, 130, 0.15);

            /* Active/Selected in dark mode = masterbrand pink */
            --active-bg: #FFB0CD;
            --active-text: #1D1C1B;

            /* Modality colors (product line) */
            --visual: #6CD5FD;
            --visual-bg: rgba(108, 213, 253, 0.15);
            --audio: #60E21B;
            --audio-bg: rgba(96, 226, 27, 0.15);
            --transcription: #FABA17;
            --transcription-bg: rgba(250, 186, 23, 0.15);

            /* Modality bar fills */
            --visual-fill: #6CD5FD;
            --audio-fill: #60E21B;
            --transcription-fill: #FABA17;

            /* System */
            --error: #E22622;
            --warning: #FABA17;
            --success: #60E21B;
            --info: #6CD5FD;

            /* Misc */
            --overlay: rgba(0, 0, 0, 0.85);
            --card-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            --gradient-brand: linear-gradient(90deg, #60E21B, #FABA17, #FFB0CD);

            /* Toggle */
            --toggle-off: #45423F;
            --toggle-on: #00DC82;

            /* Spinner */
            --spinner-track: #45423F;

            /* Syntax highlighting */
            --syntax-key: #6CD5FD;
            --syntax-string: #60E21B;
            --syntax-number: #FABA17;
            --syntax-boolean: #FFB592;
            --syntax-null: #9B9895;
        }

        [data-theme="light"] {
            --bg-body: #F4F3F3;
            --bg-header: #FFFFFF;
            --bg-surface: #FFFFFF;
            --bg-surface-hover: #ECECEC;
            --bg-input: #FFFFFF;
            --bg-deep: #F4F3F3;
            --bg-elevated: #ECECEC;
            --bg-card: #ECECEC;

            --border: #D3D1CF;
            --border-light: #E8E7E5;
            --border-hover: #9B9895;
            --border-focus: #00DC82;

            --text-primary: #1D1C1B;
            --text-secondary: #6B6966;
            --text-tertiary: #9B9895;
            --text-inverse: #FFFFFF;

            --accent: #00DC82;
            --accent-hover: #00B86E;
            --accent-light: #E8F5E9;
            --accent-muted: rgba(0, 220, 130, 0.1);

            /* Active/Selected in light mode = charcoal */
            --active-bg: #1D1C1B;
            --active-text: #F4F3F3;

            --visual: #366B7F;
            --visual-bg: rgba(108, 213, 253, 0.12);
            --audio: #30710E;
            --audio-bg: rgba(96, 226, 27, 0.12);
            --transcription: #7D5D0C;
            --transcription-bg: rgba(250, 186, 23, 0.12);

            --visual-fill: #6CD5FD;
            --audio-fill: #60E21B;
            --transcription-fill: #FABA17;

            --error: #E22622;
            --warning: #FABA17;
            --success: #60E21B;
            --info: #6CD5FD;

            --overlay: rgba(0, 0, 0, 0.5);
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            --gradient-brand: linear-gradient(90deg, #60E21B, #FABA17, #FFB0CD);

            --toggle-off: #D3D1CF;
            --toggle-on: #00DC82;

            --spinner-track: #D3D1CF;

            --syntax-key: #366B7F;
            --syntax-string: #30710E;
            --syntax-number: #7D5D0C;
            --syntax-boolean: #805B49;
            --syntax-null: #9B9895;
        }

        /* =============================================
           Base Styles — Strand Typography
           Font stack: Noto Sans (system), IBM Plex Mono (code)
           Milling (brand) falls back to Noto Sans
           ============================================= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--bg-body);
            color: var(--text-primary);
            min-height: 100vh;
            font-size: 14px;
            line-height: 1.5;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        /* =============================================
           Header — 56px height per Strand layout sizing
           ============================================= */
        header {
            background: var(--bg-header);
            padding: 12px 24px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 8px 16px;
            align-items: center;
            border-bottom: 2px solid;
            border-image: var(--gradient-brand) 1;
            transition: background-color 0.2s ease;
        }

        .header-top {
            display: contents;
        }

        .header-bottom {
            grid-column: 2 / -1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-options {
            display: flex;
            align-items: center;
            gap: 0;
            margin-left: auto;
        }

        /* =============================================
           Partner Logos & Theme Toggle
           ============================================= */
        .partner-logos {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .partner-logos .tl-logo-svg {
            height: 20px;
            width: auto;
            color: var(--text-primary);
        }

        .partner-logos img {
            height: 28px;
            width: auto;
            object-fit: contain;
        }

        /* Bedrock logo is white-on-transparent — invert for light mode */
        [data-theme="light"] .partner-logos img[alt="Amazon Bedrock"] {
            filter: brightness(0) saturate(100%);
        }

        .partner-logos .separator {
            color: var(--text-tertiary);
            font-size: 20px;
            font-weight: 300;
        }

        .theme-toggle {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px;
            cursor: pointer;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            color: var(--accent);
            border-color: var(--accent);
            background: var(--accent-muted);
            border-radius: 12px;
        }

        .theme-toggle svg {
            width: 18px;
            height: 18px;
        }

        [data-theme="dark"] .theme-icon-sun { display: block; }
        [data-theme="dark"] .theme-icon-moon { display: none; }
        [data-theme="light"] .theme-icon-sun { display: none; }
        [data-theme="light"] .theme-icon-moon { display: block; }

        /* =============================================
           Search — Strand input + button patterns
           ============================================= */
        .search-container {
            flex: 1;
            display: flex;
            gap: 8px;
        }

        .search-input-wrapper {
            flex: 1;
            position: relative;
        }

        .search-input {
            width: 100%;
            height: 100%;
            padding: 10px 16px 10px 40px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-input);
            color: var(--text-primary);
            font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
            font-size: 14px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 2px var(--accent-muted);
        }

        .search-input::placeholder {
            color: var(--text-tertiary);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
        }

        /* Search button — Strand "black" variant in dark, charcoal in light */
        .search-btn {
            padding: 10px 18px;
            background: var(--active-bg);
            border: none;
            border-radius: 10px;
            color: var(--active-text);
            font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-radius 0.2s ease;
        }

        .search-btn:hover {
            background: var(--accent);
            color: var(--text-inverse);
            border-radius: 12px;
        }

        .search-btn:active {
            transform: scale(0.98);
        }

        /* =============================================
           Image Upload — Coming Soon overlay
           ============================================= */
        .image-upload-container {
            display: flex;
            align-items: stretch;
            gap: 8px;
            position: relative;
        }

        .image-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .image-upload-label:hover {
            border-color: var(--border-hover);
            color: var(--text-primary);
            border-radius: 10px;
        }

        .image-upload-label svg {
            color: var(--text-tertiary);
            transition: color 0.2s ease;
        }

        .image-upload-label:hover svg {
            color: var(--text-primary);
        }

        #imagePreview {
            position: relative;
            display: none;
            align-items: center;
            padding: 4px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            flex-shrink: 0;
        }

        #imagePreview.active {
            display: flex;
        }

        #previewImg {
            height: 40px;
            width: 40px;
            border-radius: 4px;
            object-fit: cover;
        }

        #removeImage {
            position: absolute;
            top: -8px;
            right: -8px;
            padding: 4px;
            background: var(--error);
            border: 2px solid var(--bg-body);
            border-radius: 50%;
            color: #fff;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }

        #removeImage:hover {
            background: #9D422B;
        }

        /* =============================================
           Mode Buttons — Strand button patterns
           Rounded rectangles, NOT pills.
           Hover: radius bumps up one level + 200ms
           ============================================= */
        .modality-selector {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .modality-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--text-secondary);
            font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modality-btn:hover {
            border-color: var(--border-hover);
            color: var(--text-primary);
            border-radius: 10px;
        }

        .modality-btn.active {
            background: var(--active-bg);
            border-color: var(--active-bg);
            color: var(--active-text);
            font-weight: 600;
        }

        /* =============================================
           Main Content
           ============================================= */
        main {
            padding: 32px;
            transition: background-color 0.2s ease;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-light);
        }

        .results-count {
            color: var(--text-tertiary);
            font-size: 12px;
        }

        .query-display {
            font-size: 20px;
            color: var(--text-secondary);
        }

        /* =============================================
           Results Grid & Cards — Strand card pattern
           ============================================= */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
        }

        .result-card {
            background: var(--bg-surface);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            border: 1px solid var(--border-light);
        }

        .result-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--card-shadow);
            border-color: var(--accent);
        }

        .thumbnail-container {
            position: relative;
            aspect-ratio: 16/9;
            background: #0f0f0f;
            overflow: hidden;
        }

        .thumbnail-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }

        .thumbnail-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: var(--text-tertiary);
            font-size: 3rem;
            position: absolute;
            top: 0;
            left: 0;
        }

        .thumbnail-placeholder.hidden {
            display: none;
        }

        .play-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 56px;
            height: 56px;
            background: rgba(0, 220, 130, 0.9);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease, border-radius 0.2s ease;
        }

        .result-card:hover .play-overlay {
            opacity: 1;
            border-radius: 20px;
        }

        .play-overlay svg {
            width: 24px;
            height: 24px;
            margin-left: 4px;
        }

        .duration-badge {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            font-family: 'IBM Plex Mono', monospace;
        }

        .score-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: var(--accent);
            color: var(--text-inverse);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .rank-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: var(--accent);
            color: var(--text-inverse);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 700;
            min-width: 28px;
            text-align: center;
            font-family: 'IBM Plex Mono', monospace;
        }

        .confidence-badge {
            position: absolute;
            top: 40px;
            right: 8px;
            background: rgba(0, 0, 0, 0.75);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            font-family: 'IBM Plex Mono', monospace;
        }

        .confidence-value {
            color: #fff;
        }

        .card-info {
            padding: 16px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-meta {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .meta-tag {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 500;
        }

        .meta-tag.visual { background: var(--visual-bg); color: var(--visual); }
        .meta-tag.audio { background: var(--audio-bg); color: var(--audio); }
        .meta-tag.transcription { background: var(--transcription-bg); color: var(--transcription); }

        /* =============================================
           Video Modal — Strand modal pattern
           ============================================= */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            width: 90%;
            max-width: 1200px;
            background: var(--bg-surface);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
        }

        .modal-title {
            font-size: 16px;
            font-weight: 500;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            line-height: 1;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            color: var(--text-primary);
            background: var(--bg-elevated);
        }

        .video-container {
            aspect-ratio: 16/9;
            background: #000;
        }

        .video-container video {
            width: 100%;
            height: 100%;
        }

        .modal-info {
            padding: 16px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* =============================================
           Loading & Empty States
           ============================================= */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 64px;
            color: var(--text-secondary);
            gap: 16px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--spinner-track);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 64px;
            color: var(--text-tertiary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* =============================================
           Weights & Dynamic Panels — Strand surface
           ============================================= */
        .weights-panel {
            background: var(--bg-surface);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: none;
            border: 1px solid var(--border-light);
        }

        .weights-panel.active {
            display: block;
        }

        .weights-panel-title {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .weight-row {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 8px;
        }

        .weight-label {
            width: 100px;
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .weight-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 4px;
            border-radius: 4px;
            background: var(--border);
        }

        .weight-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 8px;
            background: var(--accent);
            cursor: pointer;
            transition: transform 0.15s ease;
        }

        .weight-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .weight-value {
            width: 50px;
            text-align: right;
            font-size: 12px;
            color: var(--text-secondary);
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 500;
        }

        .dynamic-weights-panel {
            background: var(--bg-surface);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: none;
            border: 1px solid var(--border-light);
        }

        .dynamic-weights-panel.active {
            display: block;
        }

        .dynamic-weight-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .dynamic-weight-label {
            width: 100px;
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .dynamic-weight-bar-container {
            flex: 1;
            height: 6px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .dynamic-weight-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .dynamic-weight-bar-fill.visual { background: var(--visual-fill); }
        .dynamic-weight-bar-fill.audio { background: var(--audio-fill); }
        .dynamic-weight-bar-fill.transcription { background: var(--transcription-fill); }

        .dynamic-weight-value {
            width: 50px;
            text-align: right;
            font-size: 12px;
            font-weight: 600;
            font-family: 'IBM Plex Mono', monospace;
        }

        .dynamic-weight-value.visual { color: var(--visual); }
        .dynamic-weight-value.audio { color: var(--audio); }
        .dynamic-weight-value.transcription { color: var(--transcription); }

        /* Dominant modality indicator */
        .dominant-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            font-family: 'IBM Plex Mono', monospace;
        }

        .dominant-indicator.visual { background: rgba(108, 213, 253, 0.9); color: #1D1C1B; }
        .dominant-indicator.audio { background: rgba(96, 226, 27, 0.9); color: #1D1C1B; }
        .dominant-indicator.transcription { background: rgba(250, 186, 23, 0.9); color: #1D1C1B; }

        /* Modality score bars in cards */
        .modality-bars {
            display: flex;
            gap: 2px;
            margin-top: 8px;
        }

        .modality-bar {
            flex: 1;
            height: 3px;
            border-radius: 2px;
            background: var(--border);
            overflow: hidden;
        }

        .modality-bar-fill {
            height: 100%;
            transition: width 0.2s ease;
        }

        .modality-bar-fill.visual { background: var(--visual-fill); }
        .modality-bar-fill.audio { background: var(--audio-fill); }
        .modality-bar-fill.transcription { background: var(--transcription-fill); }

        /* Mode description */
        .mode-description {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 8px;
            font-family: 'IBM Plex Mono', monospace;
        }

        /* =============================================
           Backend, Index, Decomposition Controls
           ============================================= */
        .backend-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-left: 16px;
            border-left: 1px solid var(--border);
        }

        .backend-selector-label {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .backend-dropdown {
            background: var(--bg-elevated);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 4px 8px;
            font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
            font-size: 12px;
            cursor: pointer;
            outline: none;
            transition: all 0.2s ease;
        }

        .backend-dropdown:hover {
            border-color: var(--accent);
        }

        .backend-dropdown:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-muted);
        }

        .index-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-left: 16px;
            border-left: 1px solid var(--border);
        }

        .index-toggle-label {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .index-mode-indicator {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent);
            font-family: 'IBM Plex Mono', monospace;
        }

        .decomposition-toggle {
            display: none;
            align-items: center;
            gap: 8px;
            padding-left: 16px;
            border-left: 1px solid var(--border);
        }

        .decomposition-toggle.visible {
            display: flex;
        }

        .decomposition-toggle-label {
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        /* =============================================
           Decomposed Queries
           ============================================= */
        .decomposed-queries {
            display: none;
            background: var(--bg-surface);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .decomposed-queries.visible {
            display: block;
        }

        .decomposed-queries-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .decomposed-query-item {
            margin-bottom: 8px;
            padding: 8px 12px;
            background: var(--bg-elevated);
            border-radius: 8px;
        }

        .decomposed-query-item:last-child {
            margin-bottom: 0;
        }

        .decomposed-query-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .decomposed-query-text {
            font-size: 14px;
            color: var(--text-primary);
        }

        /* =============================================
           Toggle Switch — Strand pattern
           ============================================= */
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--toggle-off);
            transition: 0.2s ease;
            border-radius: 12px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: #fff;
            transition: 0.2s ease;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--toggle-on);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .toggle-switch input:not(:checked) + .toggle-slider {
            background-color: var(--toggle-off);
        }

        .decomposition-toggle .toggle-switch input:checked + .toggle-slider {
            background-color: var(--toggle-on);
        }

        .decomposition-toggle .toggle-switch input:not(:checked) + .toggle-slider {
            background-color: var(--toggle-off);
        }

        .toggle-switch input:disabled + .toggle-slider {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Fusion/Single Mode Labels */
        .fusion-label, .single-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .fusion-label {
            background: var(--accent-muted);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .single-label {
            background: transparent;
            color: var(--text-tertiary);
        }

        /* =============================================
           Code Inspection Modal
           ============================================= */
        .code-inspection-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .code-inspection-modal.active {
            display: flex;
        }

        .code-modal-content {
            width: 90%;
            max-width: 1400px;
            height: 80vh;
            background: var(--bg-surface);
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
        }

        .code-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-elevated);
        }

        .code-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .code-modal-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* Code buttons — Strand button variants */
        .code-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-surface);
            color: var(--text-secondary);
            font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .code-btn:hover {
            background: var(--bg-surface-hover);
            border-color: var(--border-hover);
            border-radius: 10px;
        }

        .code-btn.primary {
            background: var(--active-bg);
            border-color: var(--active-bg);
            color: var(--active-text);
        }

        .code-btn.primary:hover {
            background: var(--accent);
            color: var(--text-inverse);
            border-radius: 10px;
        }

        .code-modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            line-height: 1;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .code-modal-close:hover {
            color: var(--text-primary);
            background: var(--bg-surface-hover);
        }

        .code-tabs {
            display: flex;
            gap: 0;
            padding: 0 24px;
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-elevated);
        }

        .code-tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .code-tab:hover {
            color: var(--text-primary);
        }

        .code-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .code-content-area {
            flex: 1;
            overflow: auto;
            padding: 24px;
            background: var(--bg-deep);
        }

        .code-panel {
            display: none;
        }

        .code-panel.active {
            display: block;
        }

        .code-block {
            background: var(--bg-body);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 24px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-secondary);
            overflow-x: auto;
            white-space: pre;
        }

        /* JSON Syntax Highlighting */
        .json-key { color: var(--syntax-key); }
        .json-string { color: var(--syntax-string); }
        .json-number { color: var(--syntax-number); }
        .json-boolean { color: var(--syntax-boolean); }
        .json-null { color: var(--syntax-null); }

        /* =============================================
           Show Code Button (FAB) — Strand black button
           ============================================= */
        .show-code-btn {
            position: fixed;
            bottom: 32px;
            right: 32px;
            padding: 10px 18px;
            background: var(--active-bg);
            border: none;
            border-radius: 12px;
            color: var(--active-text);
            font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 100;
            display: none;
        }

        .show-code-btn.visible {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .show-code-btn:hover {
            background: var(--accent);
            color: var(--text-inverse);
            border-radius: 16px;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 220, 130, 0.3);
        }

        .show-code-btn svg {
            display: inline-block;
            vertical-align: middle;
        }

        /* =============================================
           Responsive
           ============================================= */
        @media (max-width: 768px) {
            header {
                padding: 8px 16px;
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .header-bottom {
                grid-column: 1;
                flex-wrap: wrap;
                gap: 8px;
            }

            .search-options {
                margin-left: 0;
                flex-wrap: wrap;
            }

            .partner-logos .tl-logo-svg {
                height: 16px;
            }

            .partner-logos img {
                height: 20px;
            }

            .modality-btn {
                font-size: 11px;
                padding: 4px 8px;
            }

            .backend-selector,
            .index-toggle,
            .decomposition-toggle {
                font-size: 11px;
            }

            .backend-dropdown {
                font-size: 11px;
                padding: 4px;
            }

            .search-input {
                font-size: 14px;
            }

            .search-btn {
                padding: 10px 12px;
                font-size: 14px;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            main {
                padding: 16px;
            }
        }

        @media (max-width: 480px) {
            .header-bottom {
                grid-column: 1;
                flex-direction: column;
                align-items: stretch;
            }

            .modality-selector {
                flex-wrap: wrap;
            }

            .search-options {
                margin-left: 0;
                flex-direction: column;
                align-items: stretch;
            }

            .backend-selector,
            .index-toggle,
            .decomposition-toggle {
                width: 100%;
                justify-content: space-between;
                border-left: none;
                padding-left: 0;
                padding-top: 8px;
                border-top: 1px solid var(--border);
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-top">
            <div class="partner-logos">
                <!-- Strand: Inline SVG logo uses currentColor — auto-adapts to theme -->
                <svg class="tl-logo-svg" viewBox="0 0 179 36" fill="none" xmlns="http://www.w3.org/2000/svg" title="TwelveLabs Marengo 3.0">
                    <g><rect x="10.78" y="12.36" width="15.81" height="2.14" rx="0.63" fill="currentColor"/><rect x="0.00" y="12.36" width="8.66" height="2.14" rx="0.63" fill="currentColor"/><rect x="30.51" y="12.36" width="9.89" height="2.14" rx="0.63" fill="currentColor"/><rect x="31.93" y="9.28" width="8.47" height="2.15" rx="0.63" fill="currentColor"/><rect x="41.51" y="9.28" width="6.73" height="2.15" rx="0.63" fill="currentColor"/><rect x="38.65" y="6.14" width="7.66" height="2.15" rx="0.63" fill="currentColor"/><rect x="41.08" y="3.07" width="2.24" height="2.15" rx="0.63" fill="currentColor"/><rect x="18.26" y="27.71" width="3.90" height="2.15" rx="0.63" fill="currentColor"/><rect x="25.02" y="27.71" width="2.56" height="2.15" rx="0.63" fill="currentColor"/><rect x="28.74" y="27.71" width="6.88" height="2.15" rx="0.63" fill="currentColor"/><rect x="32.20" y="24.64" width="2.87" height="2.14" rx="0.63" fill="currentColor"/><rect x="12.88" y="27.71" width="2.24" height="2.15" rx="0.63" fill="currentColor"/><rect x="23.29" y="30.78" width="2.24" height="2.15" rx="0.63" fill="currentColor"/><rect x="21.09" y="33.86" width="2.15" height="2.14" rx="0.63" fill="currentColor"/><rect x="29.58" y="0.00" width="2.80" height="2.15" rx="0.63" fill="currentColor"/><rect x="13.71" y="9.28" width="7.14" height="2.15" rx="0.63" fill="currentColor"/><rect x="26.96" y="3.07" width="4.32" height="2.15" rx="0.63" fill="currentColor"/><rect x="24.29" y="6.14" width="6.99" height="2.15" rx="0.63" fill="currentColor"/><rect x="46.04" y="12.36" width="4.08" height="2.14" rx="0.63" fill="currentColor"/><rect x="7.52" y="15.43" width="20.15" height="2.15" rx="0.63" fill="currentColor"/><rect x="25.83" y="21.57" width="7.87" height="2.15" rx="0.63" fill="currentColor"/><rect x="10.78" y="18.50" width="25.62" height="2.15" rx="0.63" fill="currentColor"/><rect x="6.85" y="21.57" width="9.52" height="2.15" rx="0.63" fill="currentColor"/><rect x="15.56" y="24.64" width="3.11" height="2.14" rx="0.63" fill="currentColor"/><rect x="26.58" y="24.64" width="3.38" height="2.14" rx="0.63" fill="currentColor"/><rect x="9.79" y="24.64" width="3.17" height="2.14" rx="0.63" fill="currentColor"/><rect x="30.51" y="15.43" width="8.14" height="2.15" rx="0.63" fill="currentColor"/><rect x="32.40" y="6.12" width="2.24" height="2.15" rx="0.63" fill="currentColor"/></g>
                    <g transform="translate(58.97 9.09) scale(1)"><path d="M115.418 17.8126C111.474 17.8126 110.369 15.7119 110.391 13.9613C110.396 13.5236 110.675 13.3048 111.119 13.3048H111.906C112.36 13.3048 112.557 13.5455 112.601 13.9995C112.716 15.0827 113.427 15.7502 115.391 15.7502C117.404 15.7502 118.302 15.0335 118.302 13.9284C118.302 12.9546 117.749 12.5991 116.376 12.3638L114.013 11.959C112.032 11.6198 110.719 10.5038 110.719 8.50152C110.719 6.2476 112.393 4.59546 115.49 4.59546C118.695 4.59546 120.364 6.27496 120.337 8.23346C120.331 8.66564 120.041 8.88447 119.604 8.88447H118.805C118.351 8.88447 118.187 8.64376 118.121 8.20063C118.006 7.3855 117.339 6.64149 115.49 6.64149C113.651 6.64149 112.929 7.41833 112.929 8.42493C112.929 9.29477 113.433 9.67771 114.691 9.90201L117.054 10.3178C119.1 10.6788 120.523 11.68 120.523 13.8245C120.523 15.8268 119.314 17.8126 115.418 17.8126Z" fill="currentColor"/><path d="M99.5039 16.8059C99.5039 17.26 99.2577 17.5062 98.8037 17.5062H97.9776C97.5235 17.5062 97.2773 17.26 97.2773 16.8059V0.700246C97.2773 0.24618 97.5235 0 97.9776 0H98.8091C99.2632 0 99.5094 0.24618 99.5094 0.700246V6.47181C100.248 5.31749 101.572 4.59536 103.268 4.59536C106.506 4.59536 108.963 7.16111 108.963 11.2039C108.963 15.2468 106.506 17.8125 103.268 17.8125C101.566 17.8125 100.242 17.0904 99.5039 15.9306V16.8059ZM106.709 11.2039C106.709 8.28807 105.04 6.67422 103.054 6.67422C101.069 6.67422 99.3781 8.28807 99.3781 11.2039C99.3781 14.1198 101.069 15.7337 103.054 15.7337C105.04 15.7337 106.709 14.1198 106.709 11.2039Z" fill="currentColor"/><path d="M89.657 4.59546C93.0488 4.59546 94.5861 6.20384 94.5806 8.80241L94.5696 13.6002C94.5696 14.5193 94.6025 15.8377 94.7228 16.7568C94.783 17.2327 94.5806 17.5062 94.0992 17.5062H93.3552C92.923 17.5062 92.6768 17.3421 92.633 17.0084L92.5072 16.062C91.8398 17.1616 90.5323 17.7251 88.9294 17.7251C86.0354 17.7251 84.252 16.0182 84.252 13.6932C84.252 11.6581 85.6853 10.4053 88.1252 10.2303L91.6866 9.9786C92.3321 9.93484 92.3595 9.87466 92.3595 9.27288V8.74223C92.3595 7.34174 91.5115 6.63055 89.657 6.63055C87.8462 6.63055 87.042 7.32532 86.9654 8.2991C86.9326 8.75864 86.7739 9.00482 86.3089 9.00482H85.4555C85.0124 9.00482 84.7334 8.78052 84.7279 8.34287C84.7115 6.29684 86.2159 4.59546 89.657 4.59546ZM86.5059 13.7151C86.5059 14.9405 87.507 15.8213 89.2139 15.8213C91.2107 15.8213 92.3595 14.6177 92.3595 12.8124V11.6253C92.0969 11.7183 91.7851 11.7839 91.4295 11.8167L88.3112 12.1122C87.1733 12.2216 86.5059 12.6592 86.5059 13.7151Z" fill="currentColor"/><path d="M73.5518 17.5062C73.0977 17.5062 72.8516 17.26 72.8516 16.8059V0.700246C72.8516 0.24618 73.0977 0 73.5518 0H74.4271C74.8812 0 75.1274 0.24618 75.1274 0.700246V15.3507H82.9832C83.4373 15.3507 83.6835 15.5969 83.6835 16.051V16.8059C83.6835 17.26 83.4373 17.5062 82.9832 17.5062H73.5518Z" fill="currentColor"/><path d="M65.176 17.8126C61.5216 17.8126 59.0762 15.2086 59.0762 11.122C59.0762 7.07914 61.4833 4.59546 64.9681 4.59546C68.4967 4.59546 70.6904 7.13385 70.6904 10.739V11.0071C70.6904 11.4612 70.4442 11.7073 69.9902 11.7073H61.3301C61.5216 14.2184 62.9658 15.7392 65.176 15.7392C66.7132 15.7392 67.6487 15.1374 68.0262 14.0871C68.1684 13.6877 68.3763 13.4798 68.7976 13.4798H69.6018C70.0722 13.4798 70.3512 13.7424 70.2692 14.2074C69.9026 16.341 67.9113 17.8126 65.176 17.8126ZM61.4176 9.81995H68.4201C68.163 7.7958 66.9156 6.55396 64.9681 6.55396C63.0807 6.55396 61.7896 7.76845 61.4176 9.81995Z" fill="currentColor"/><path d="M51.9967 17.506C51.5918 17.506 51.3402 17.331 51.1925 16.9535L47.0676 6.05045C46.9363 5.71127 46.9308 5.47603 47.0512 5.23532C47.1661 5.00555 47.3958 4.90161 47.7897 4.90161H48.4024C48.8073 4.90161 49.0644 5.07667 49.2066 5.45962L52.5602 14.4753L52.7462 15.0552L52.9322 14.4753L56.2857 5.45962C56.4279 5.07667 56.685 4.90161 57.0899 4.90161H57.7026C58.0965 4.90161 58.3262 5.00555 58.4411 5.23532C58.5615 5.47603 58.556 5.71127 58.4247 6.05045L54.2998 16.9535C54.1521 17.331 53.9005 17.506 53.4956 17.506H51.9967Z" fill="currentColor"/><path d="M43.209 0.700246C43.209 0.24618 43.4552 0 43.9092 0H44.7408C45.1948 0 45.441 0.24618 45.441 0.700246V16.8059C45.441 17.26 45.1948 17.5062 44.7408 17.5062H43.9092C43.4552 17.5062 43.209 17.26 43.209 16.8059V0.700246Z" fill="currentColor"/><path d="M35.6818 17.8126C32.0274 17.8126 29.582 15.2086 29.582 11.122C29.582 7.07914 31.9891 4.59546 35.4739 4.59546C39.0025 4.59546 41.1963 7.13385 41.1963 10.739V11.0071C41.1963 11.4612 40.9501 11.7073 40.496 11.7073H31.8359C32.0274 14.2184 33.4717 15.7392 35.6818 15.7392C37.2191 15.7392 38.1546 15.1374 38.5321 14.0871C38.6743 13.6877 38.8822 13.4798 39.3034 13.4798H40.1076C40.5781 13.4798 40.8571 13.7424 40.775 14.2074C40.4085 16.341 38.4172 17.8126 35.6818 17.8126ZM31.9235 9.81995H38.9259C38.6688 7.7958 37.4215 6.55396 35.4739 6.55396C33.5866 6.55396 32.2955 7.76845 31.9235 9.81995Z" fill="currentColor"/><path d="M14.5079 17.506C14.0976 17.506 13.8405 17.32 13.7202 16.9262L10.3502 6.03404C10.2408 5.68939 10.2463 5.45962 10.3612 5.22438C10.4761 5.00008 10.7004 4.90161 11.0942 4.90161H11.7179C12.1337 4.90161 12.3853 5.08761 12.5057 5.48697L15.241 14.53L15.2903 14.7488L15.3395 14.5191L18.1514 5.4815C18.2718 5.08761 18.5289 4.90161 18.9392 4.90161H20.2084C20.6187 4.90161 20.8758 5.08761 20.9962 5.4815L23.8081 14.5191L23.8628 14.7652L23.9175 14.5245L26.6528 5.48697C26.7732 5.08761 27.0248 4.90161 27.4406 4.90161H28.0533C28.4472 4.90161 28.6715 5.00008 28.7864 5.22438C28.9013 5.45962 28.9068 5.68939 28.7973 6.03404L25.4274 16.9262C25.3071 17.32 25.0499 17.506 24.6396 17.506H23.2337C22.8234 17.506 22.5662 17.32 22.4459 16.9262L19.6394 7.8886L19.5683 7.60412L19.4972 7.8886L16.6962 16.9262C16.5704 17.32 16.3133 17.506 15.903 17.506H14.5079Z" fill="currentColor"/><path d="M0.700246 2.1445C0.24618 2.1445 0 1.89832 0 1.44426V0.700246C0 0.24618 0.24618 0 0.700246 0H12.6646C13.1187 0 13.3649 0.24618 13.3649 0.700246V1.44426C13.3649 1.89832 13.1187 2.1445 12.6646 2.1445H7.82306V16.8059C7.82306 17.26 7.57688 17.5062 7.12282 17.5062H6.24751C5.79344 17.5062 5.54726 17.26 5.54726 16.8059V2.1445H0.700246Z" fill="currentColor"/></g>
                </svg>
                <span class="separator">|</span>
                <img src="/static/images/bedrock-logo.png" alt="Amazon Bedrock" title="Amazon Bedrock">
            </div>

            <div class="search-container">
                <div class="search-input-wrapper">
                    <!-- Strand: magnifying-glass icon for search -->
                    <svg class="search-icon" width="16" height="16" viewBox="0 0 12 11.707" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.5 0C9.98528 0 12 2.01472 12 4.5C12 6.98528 9.98528 9 7.5 9C6.36252 8.99998 5.32451 8.57691 4.53223 7.88086L0.707031 11.707L0 11L3.85742 7.1416C3.31847 6.39969 3 5.48716 3 4.5C3 2.01474 5.01475 4.07169e-05 7.5 0ZM7.5 1C5.56704 1.00004 4 2.56703 4 4.5C4 6.43297 5.56704 7.99996 7.5 8C9.433 8 11 6.433 11 4.5C11 2.567 9.433 1 7.5 1Z"/>
                    </svg>
                    <input type="text" class="search-input" id="searchInput" placeholder="Search videos... (e.g., 'romantic scene', 'people talking')">
                </div>

                <!-- Image Upload Section — Coming Soon -->
                <div class="image-upload-container">
                    <label for="imageUpload" class="image-upload-label" title="Upload an image to search for similar video content">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                    </label>
                    <input type="file" id="imageUpload" accept="image/jpeg,image/png,image/gif,image/webp" style="display: none;">

                    <!-- Image Preview -->
                    <div id="imagePreview" style="display: none;">
                        <img id="previewImg" alt="Query image preview">
                        <button id="removeImage" title="Remove image" type="button">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                </div>

                <button class="search-btn" id="searchBtn">Search</button>
            </div>

            <button class="theme-toggle" id="themeToggle" title="Toggle theme" aria-label="Toggle dark/light mode">
                <svg class="theme-icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
                <svg class="theme-icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
        </div>

        <div class="header-bottom">
            <div class="modality-selector">
                <button class="modality-btn active" data-mode="fused" title="Simple fusion with fixed default weights (visual=0.8, audio=0.1, transcription=0.05)">Fused</button>
                <button class="modality-btn" data-mode="rrf" title="Multi-vector fusion using Reciprocal Rank Fusion">RRF</button>
                <button class="modality-btn" data-mode="weighted" title="Multi-vector fusion with adjustable weighted score combination">Weighted</button>
                <button class="modality-btn" data-mode="dynamic" title="Multi-vector fusion with dynamic intent routing">Dynamic</button>
                <button class="modality-btn" data-mode="visual" title="Search visual content only">Visual</button>
                <button class="modality-btn" data-mode="audio" title="Search audio/sound only">Audio</button>
                <button class="modality-btn" data-mode="transcription" title="Search speech/transcription only">Speech</button>
            </div>

            <div class="search-options">
                <div class="backend-selector">
                    <span class="backend-selector-label">Vector DB:</span>
                    <select class="backend-dropdown" id="backendDropdown" title="Choose vector database backend">
                        <option value="s3vectors">S3 Vectors</option>
                        <option value="mongodb">MongoDB</option>
                    </select>
                </div>

                <div class="index-toggle">
                    <span class="index-toggle-label">Index Mode:</span>
                    <span class="index-mode-indicator" id="indexModeIndicator">Multi-Index</span>
                    <label class="toggle-switch" title="Toggle between Unified-Index (single collection with all modalities) and Multi-Index (separate modality collections)">
                        <input type="checkbox" id="indexModeToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="decomposition-toggle" id="decompositionToggleContainer">
                    <span class="decomposition-toggle-label">LLM Decomposition:</span>
                    <label class="toggle-switch" title="Use Claude Haiku to decompose queries per modality (RRF/Weighted/Dynamic only)">
                        <input type="checkbox" id="decompositionToggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </header>

    <main>
        <!-- Fused mode: fixed weights info -->
        <div class="weights-panel active" id="fusedPanel">
            <div class="weights-panel-title">Fused Embeddings (Fixed Weights)</div>
            <div class="weight-row">
                <span class="weight-label">Visual</span>
                <div style="flex: 1; height: 4px; background: var(--border); border-radius: 4px; overflow: hidden;">
                    <div style="width: 80%; height: 100%; background: var(--visual-fill);"></div>
                </div>
                <span class="weight-value">0.80</span>
            </div>
            <div class="weight-row">
                <span class="weight-label">Audio</span>
                <div style="flex: 1; height: 4px; background: var(--border); border-radius: 4px; overflow: hidden;">
                    <div style="width: 10%; height: 100%; background: var(--audio-fill);"></div>
                </div>
                <span class="weight-value">0.10</span>
            </div>
            <div class="weight-row">
                <span class="weight-label">Transcription</span>
                <div style="flex: 1; height: 4px; background: var(--border); border-radius: 4px; overflow: hidden;">
                    <div style="width: 5%; height: 100%; background: var(--transcription-fill);"></div>
                </div>
                <span class="weight-value">0.05</span>
            </div>
            <div class="mode-description">Fused Embeddings (Section 2.2): Fixed weights optimized for visual-heavy queries. Simple weighted fusion at query time.</div>
        </div>

        <!-- Weighted mode: manual sliders -->
        <div class="weights-panel" id="weightsPanel">
            <div class="weights-panel-title">Adjust Modality Weights</div>
            <div class="weight-row">
                <span class="weight-label">Visual</span>
                <input type="range" class="weight-slider" id="visualWeight" min="0" max="100" value="80">
                <span class="weight-value" id="visualValue">0.80</span>
            </div>
            <div class="weight-row">
                <span class="weight-label">Audio</span>
                <input type="range" class="weight-slider" id="audioWeight" min="0" max="100" value="10">
                <span class="weight-value" id="audioValue">0.10</span>
            </div>
            <div class="weight-row">
                <span class="weight-label">Transcription</span>
                <input type="range" class="weight-slider" id="transcriptionWeight" min="0" max="100" value="5">
                <span class="weight-value" id="transcriptionValue">0.05</span>
            </div>
            <div class="mode-description">Weighted Score Fusion (Section 3.2.3, Eq. 3): score(s) = Σ w_m · sim(Q_m, E_m(s)) — adjustable weights per modality</div>
        </div>

        <!-- Dynamic mode: auto-computed weights display -->
        <div class="dynamic-weights-panel" id="dynamicWeightsPanel">
            <div class="weights-panel-title">Auto-Computed Weights (based on query intent)</div>
            <div class="dynamic-weight-bar">
                <span class="dynamic-weight-label">Visual</span>
                <div class="dynamic-weight-bar-container">
                    <div class="dynamic-weight-bar-fill visual" id="dynamicVisualBar" style="width: 0%"></div>
                </div>
                <span class="dynamic-weight-value visual" id="dynamicVisualValue">-</span>
            </div>
            <div class="dynamic-weight-bar">
                <span class="dynamic-weight-label">Audio</span>
                <div class="dynamic-weight-bar-container">
                    <div class="dynamic-weight-bar-fill audio" id="dynamicAudioBar" style="width: 0%"></div>
                </div>
                <span class="dynamic-weight-value audio" id="dynamicAudioValue">-</span>
            </div>
            <div class="dynamic-weight-bar">
                <span class="dynamic-weight-label">Transcription</span>
                <div class="dynamic-weight-bar-container">
                    <div class="dynamic-weight-bar-fill transcription" id="dynamicTranscriptionBar" style="width: 0%"></div>
                </div>
                <span class="dynamic-weight-value transcription" id="dynamicTranscriptionValue">-</span>
            </div>
            <div class="mode-description">Intent-Based Dynamic Routing (Section 4.3, Eq. 4): (w_v, w_a, w_t) = softmax(α · sim(E_query, anchors)) where α=10 — auto-computes weights based on query intent</div>
        </div>

        <!-- RRF mode info -->
        <div class="weights-panel" id="rrfPanel">
            <div class="weights-panel-title">Reciprocal Rank Fusion (RRF)</div>
            <div class="mode-description">RRF (Section 3.2.3, Eq. 2): score(s) = Σ w_m/(k + rank_m(s)) where k=60 — rank-based fusion, robust to score calibration differences across modalities</div>
        </div>

        <!-- Decomposed Queries Display -->
        <div class="decomposed-queries" id="decomposedQueriesDisplay">
            <div class="decomposed-queries-title">
                Original Query: <span id="originalQueryText"></span>
            </div>
            <div class="decomposed-query-item">
                <div class="decomposed-query-label">Visual Query:</div>
                <div class="decomposed-query-text" id="visualQueryText"></div>
            </div>
            <div class="decomposed-query-item">
                <div class="decomposed-query-label">Audio Query:</div>
                <div class="decomposed-query-text" id="audioQueryText"></div>
            </div>
            <div class="decomposed-query-item">
                <div class="decomposed-query-label">Transcription Query:</div>
                <div class="decomposed-query-text" id="transcriptionQueryText"></div>
            </div>
        </div>

        <div class="results-header">
            <div>
                <span class="query-display" id="queryDisplay"></span>
                <span class="results-count" id="resultsCount"></span>
            </div>
        </div>

        <div id="resultsContainer">
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <p>Enter a search query to find video segments</p>
            </div>
        </div>
    </main>

    <!-- Video Modal -->
    <div class="modal" id="videoModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">Video Playback</span>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="video-container">
                <video id="videoPlayer" controls preload="auto"></video>
            </div>
            <div class="modal-info" id="modalInfo"></div>
        </div>
    </div>

    <!-- Code Inspection Modal -->
    <div class="code-inspection-modal" id="codeInspectionModal">
        <div class="code-modal-content">
            <div class="code-modal-header">
                <span class="code-modal-title">Search Code Inspection</span>
                <div class="code-modal-actions">
                    <button class="code-btn" id="copyCodeBtn">Copy JSON</button>
                    <button class="code-btn primary" id="exportCodeBtn">Export JSON</button>
                    <button class="code-modal-close" id="codeModalClose">&times;</button>
                </div>
            </div>
            <div class="code-tabs">
                <button class="code-tab active" data-tab="input">Input</button>
                <button class="code-tab" data-tab="output">Output</button>
            </div>
            <div class="code-content-area">
                <div class="code-panel active" id="inputPanel">
                    <pre class="code-block" id="inputCode"></pre>
                </div>
                <div class="code-panel" id="outputPanel">
                    <pre class="code-block" id="outputCode"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Show Code Button (floating) -->
    <button class="show-code-btn" id="showCodeBtn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="16 18 22 12 16 6"></polyline>
            <polyline points="8 6 2 12 8 18"></polyline>
        </svg>
        Show Code
    </button>

    <script>
        // Theme Toggle — Strand pattern: localStorage key 'strand-dark-mode'
        const themeToggle = document.getElementById('themeToggle');
        themeToggle.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('strand-dark-mode', String(next === 'dark'));
        });

        // Listen for system preference changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (localStorage.getItem('strand-dark-mode') === null) {
                document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
            }
        });

        // State
        let currentMode = 'fused';
        let currentResults = [];
        let preloadedVideoUrl = null;
        let lastDynamicWeights = null;
        let useDecomposition = false;
        let lastDecomposedQueries = null;

        // DOM Elements
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const resultsContainer = document.getElementById('resultsContainer');
        const queryDisplay = document.getElementById('queryDisplay');
        const resultsCount = document.getElementById('resultsCount');
        const fusedPanel = document.getElementById('fusedPanel');
        const weightsPanel = document.getElementById('weightsPanel');
        const dynamicWeightsPanel = document.getElementById('dynamicWeightsPanel');
        const rrfPanel = document.getElementById('rrfPanel');
        const videoModal = document.getElementById('videoModal');
        const videoPlayer = document.getElementById('videoPlayer');
        const modalTitle = document.getElementById('modalTitle');
        const modalInfo = document.getElementById('modalInfo');
        const modalClose = document.getElementById('modalClose');
        const decompositionToggle = document.getElementById('decompositionToggle');
        const decompositionToggleContainer = document.getElementById('decompositionToggleContainer');
        const decomposedQueriesDisplay = document.getElementById('decomposedQueriesDisplay');

        // Multi-vector modes that use all modalities
        const MULTI_VECTOR_MODES = ['fused', 'rrf', 'weighted', 'dynamic'];

        // Modes that support LLM decomposition (excludes Fused and SINGLE modes)
        const DECOMPOSITION_MODES = ['rrf', 'weighted', 'dynamic'];

        // Image Upload Elements
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const removeImage = document.getElementById('removeImage');
        let currentImageBase64 = null;

        // Image Upload Handler
        imageUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                alert('Image must be less than 5MB');
                e.target.value = '';
                return;
            }

            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                alert('Please upload a JPEG, PNG, GIF, or WebP image');
                e.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const base64Data = event.target.result.split(',')[1];
                currentImageBase64 = base64Data;
                previewImg.src = event.target.result;
                imagePreview.classList.add('active');
                imagePreview.style.display = 'flex';
            };
            reader.readAsDataURL(file);
        });

        // Remove Image Handler
        removeImage.addEventListener('click', function() {
            currentImageBase64 = null;
            imageUpload.value = '';
            imagePreview.classList.remove('active');
            imagePreview.style.display = 'none';
            previewImg.src = '';
        });

        // Update panel visibility based on mode
        function updatePanelVisibility() {
            fusedPanel.classList.toggle('active', currentMode === 'fused');
            weightsPanel.classList.toggle('active', currentMode === 'weighted');
            dynamicWeightsPanel.classList.toggle('active', currentMode === 'dynamic');
            rrfPanel.classList.toggle('active', currentMode === 'rrf');

            const supportsDecomposition = DECOMPOSITION_MODES.includes(currentMode);
            decompositionToggleContainer.classList.toggle('visible', supportsDecomposition);

            if (!supportsDecomposition) {
                decomposedQueriesDisplay.classList.remove('visible');
            }
        }

        // Update dynamic weights display
        function updateDynamicWeightsDisplay(weights) {
            if (!weights) return;
            lastDynamicWeights = weights;

            ['visual', 'audio', 'transcription'].forEach(modality => {
                const value = weights[modality] || 0;
                const percentage = (value * 100).toFixed(1);
                document.getElementById(`dynamic${capitalize(modality)}Bar`).style.width = `${percentage}%`;
                document.getElementById(`dynamic${capitalize(modality)}Value`).textContent = value.toFixed(3);
            });
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Display decomposed queries
        function displayDecomposedQueries(originalQuery, decomposedQueries) {
            if (!decomposedQueries) {
                decomposedQueriesDisplay.classList.remove('visible');
                return;
            }

            document.getElementById('originalQueryText').textContent = originalQuery;
            document.getElementById('visualQueryText').textContent = decomposedQueries.visual || originalQuery;
            document.getElementById('audioQueryText').textContent = decomposedQueries.audio || originalQuery;
            document.getElementById('transcriptionQueryText').textContent = decomposedQueries.transcription || originalQuery;
            decomposedQueriesDisplay.classList.add('visible');
            lastDecomposedQueries = decomposedQueries;
        }

        // Decomposition toggle event listener
        decompositionToggle.addEventListener('change', () => {
            useDecomposition = decompositionToggle.checked;

            if (!useDecomposition) {
                decomposedQueriesDisplay.classList.remove('visible');
            }

            if (searchInput.value.trim()) {
                performSearch();
            }
        });

        // All mode buttons
        document.querySelectorAll('.modality-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (!btn.dataset.mode) return;

                document.querySelectorAll('.modality-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = btn.dataset.mode;

                updatePanelVisibility();

                if (searchInput.value.trim()) {
                    performSearch();
                }
            });
        });

        // Weight sliders with debounced search
        let sliderDebounceTimer = null;
        ['visual', 'audio', 'transcription'].forEach(type => {
            const slider = document.getElementById(`${type}Weight`);
            const value = document.getElementById(`${type}Value`);

            slider.addEventListener('input', () => {
                value.textContent = (slider.value / 100).toFixed(2);

                clearTimeout(sliderDebounceTimer);
                sliderDebounceTimer = setTimeout(() => {
                    if (searchInput.value.trim() && currentMode === 'weighted') {
                        performSearch();
                    }
                }, 500);
            });
        });

        // Search
        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });

        async function performSearch() {
            const query = searchInput.value.trim();

            if (!query && !currentImageBase64) {
                alert('Please enter a search query or upload an image');
                return;
            }

            resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div><span>Searching...</span></div>';

            if (query && currentImageBase64) {
                queryDisplay.textContent = `${query} + Image`;
            } else if (currentImageBase64) {
                queryDisplay.textContent = 'Image Search';
            } else {
                queryDisplay.textContent = query;
            }

            resultsCount.textContent = '';

            try {
                let results;
                let responseData = {};

                if (currentMode === 'dynamic') {
                    const request = {
                        query: query || '',
                        query_image: currentImageBase64,
                        limit: 20,
                        backend: selectedBackend,
                        use_multi_index: useMultiIndex,
                        use_decomposition: useDecomposition
                    };
                    const response = await fetch('/api/search/dynamic', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(request)
                    });

                    if (!response.ok) throw new Error('Search failed');

                    responseData = await response.json();
                    results = responseData.results;
                    updateDynamicWeightsDisplay(responseData.computed_weights);

                    if (responseData.decomposed_queries) {
                        displayDecomposedQueries(query, responseData.decomposed_queries);
                    } else {
                        decomposedQueriesDisplay.classList.remove('visible');
                    }

                } else if (MULTI_VECTOR_MODES.includes(currentMode)) {
                    const request = {
                        query: query || '',
                        query_image: currentImageBase64,
                        limit: 20,
                        fusion_method: currentMode === 'rrf' ? 'rrf' : 'weighted',
                        backend: selectedBackend,
                        use_multi_index: useMultiIndex,
                        use_decomposition: DECOMPOSITION_MODES.includes(currentMode) && useDecomposition
                    };

                    if (currentMode === 'weighted') {
                        const visualW = document.getElementById('visualWeight').value / 100;
                        const audioW = document.getElementById('audioWeight').value / 100;
                        const transW = document.getElementById('transcriptionWeight').value / 100;

                        request.weights = {
                            visual: visualW,
                            audio: audioW,
                            transcription: transW
                        };
                    } else if (currentMode === 'fused') {
                        request.weights = {
                            visual: 0.8,
                            audio: 0.1,
                            transcription: 0.05
                        };
                    }

                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(request)
                    });

                    if (!response.ok) throw new Error('Search failed');
                    responseData = await response.json();
                    results = responseData.results;

                    if (responseData.decomposed_queries) {
                        displayDecomposedQueries(query, responseData.decomposed_queries);
                    } else {
                        decomposedQueriesDisplay.classList.remove('visible');
                    }

                } else {
                    const request = {
                        query: query || '',
                        query_image: currentImageBase64,
                        limit: 20,
                        modalities: [currentMode],
                        fusion_method: 'weighted',
                        backend: selectedBackend,
                        use_multi_index: useMultiIndex
                    };

                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(request)
                    });

                    if (!response.ok) throw new Error('Search failed');
                    responseData = await response.json();
                    results = responseData.results;

                    decomposedQueriesDisplay.classList.remove('visible');
                }

                currentResults = results || responseData.results;
                renderResults(results);

                storeSearchData(query, results, responseData);

                showCodeBtn.classList.add('visible');

                if (results.length > 0 && results[0].video_url) {
                    preloadedVideoUrl = results[0].video_url;
                }
            } catch (error) {
                console.error('Search error:', error);
                resultsContainer.innerHTML = `
                    <div class="empty-state">
                        <p>Search failed. Please try again.</p>
                    </div>
                `;
            }
        }

        // Store search data for code inspection
        function storeSearchData(query, results, responseData) {
            searchInputData = {
                mode: currentMode,
                query: query,
                backend: selectedBackend,
                use_multi_index: useMultiIndex,
                fusion_method: currentMode === 'rrf' ? 'rrf' : 'weighted',
                query_embeddings: responseData?.query_embeddings || null,
                decomposed_queries: responseData?.decomposed_queries || null,
                weights: {},
                parameters: {}
            };

            if (currentMode === 'fused') {
                searchInputData.weights = { visual: 0.8, audio: 0.1, transcription: 0.05 };
            } else if (currentMode === 'weighted') {
                searchInputData.weights = {
                    visual: parseFloat(document.getElementById('visualWeight').value) / 100,
                    audio: parseFloat(document.getElementById('audioWeight').value) / 100,
                    transcription: parseFloat(document.getElementById('transcriptionWeight').value) / 100
                };
            } else if (currentMode === 'dynamic') {
                searchInputData.weights = responseData?.computed_weights || lastDynamicWeights;
                searchInputData.anchor_similarities = responseData?.anchor_similarities;
                searchInputData.parameters.alpha = 10;
            } else if (currentMode === 'rrf') {
                searchInputData.parameters.k = 60;
            }

            searchInputData.parameters.top_k = 20;
            searchInputData.parameters.limit = 20;

            searchOutputData = {
                results: results.map(r => ({
                    segment_id: r.segment_id,
                    video_id: r.video_id,
                    start_time: r.start_time,
                    end_time: r.end_time,
                    s3_uri: r.s3_uri,
                    result_embeddings: r.embedding || null,
                    scores: {
                        ...r.modality_scores,
                        final: r.fusion_score
                    },
                    ranks: r.modality_ranks || null,
                    metadata: {
                        video_url: r.video_url,
                        thumbnail_url: r.thumbnail_url
                    }
                })),
                total_results: results.length,
                search_time_ms: responseData?.search_time_ms || null,
                backend: useMultiIndex ? 's3_vectors' : 'mongodb'
            };
        }

        function renderResults(results) {
            const modeLabel = getModeLabel(currentMode);
            resultsCount.textContent = `${results.length} results (${modeLabel})`;

            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No results found for this query.</p>
                    </div>
                `;
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'results-grid';

            results.forEach((result, index) => {
                const card = document.createElement('div');
                card.className = 'result-card';
                card.onclick = () => openVideo(result);

                const startTime = formatTime(result.start_time);
                const endTime = formatTime(result.end_time);

                const filename = result.s3_uri.split('/').pop() || 'Video';

                const modalityScores = result.modality_scores || {};
                const modalityTags = Object.entries(modalityScores)
                    .map(([mod, score]) => `<span class="meta-tag ${mod}">${mod.substring(0, 3)}: ${score.toFixed(2)}</span>`)
                    .join('');

                let dominantModality = null;
                let maxScore = 0;
                for (const [mod, score] of Object.entries(modalityScores)) {
                    if (score > maxScore) {
                        maxScore = score;
                        dominantModality = mod;
                    }
                }

                const maxPossibleScore = Math.max(...Object.values(modalityScores), 0.001);
                const modalityBars = ['visual', 'audio', 'transcription'].map(mod => {
                    const score = modalityScores[mod] || 0;
                    const width = (score / maxPossibleScore * 100).toFixed(1);
                    return `<div class="modality-bar"><div class="modality-bar-fill ${mod}" style="width: ${width}%"></div></div>`;
                }).join('');

                const showDominant = MULTI_VECTOR_MODES.includes(currentMode) && dominantModality;
                const dominantIndicator = showDominant
                    ? `<span class="dominant-indicator ${dominantModality}">${dominantModality.substring(0, 3)}</span>`
                    : '';

                const rank = index + 1;
                const confidenceScore = result.confidence_score !== undefined ? result.confidence_score : result.fusion_score;
                const confidencePercent = Math.round(confidenceScore * 100);

                card.innerHTML = `
                    <div class="thumbnail-container">
                        <div class="thumbnail-placeholder" id="placeholder-${index}">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                        </div>
                        <video
                            class="thumbnail-video"
                            muted
                            preload="metadata"
                            data-start="${result.start_time}"
                            data-index="${index}"
                            crossorigin="anonymous"
                        >
                            <source src="${result.video_url}" type="video/mp4">
                        </video>
                        <div class="play-overlay">
                            <svg viewBox="0 0 24 24" fill="white">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                        </div>
                        <span class="rank-badge">#${rank}</span>
                        <span class="confidence-badge">
                            <span class="confidence-value">${confidencePercent}%</span>
                        </span>
                        ${dominantIndicator}
                        <span class="duration-badge">${startTime} - ${endTime}</span>
                    </div>
                    <div class="card-info">
                        <div class="card-title">${filename}</div>
                        <div class="card-meta">
                            ${modalityTags}
                        </div>
                        <div class="modality-bars">
                            ${modalityBars}
                        </div>
                    </div>
                `;

                grid.appendChild(card);
            });

            resultsContainer.innerHTML = '';
            resultsContainer.appendChild(grid);

            initializeThumbnails();
        }

        function getModeLabel(mode) {
            const labels = {
                'fused': 'Fused Embeddings',
                'rrf': 'RRF Fusion',
                'weighted': 'Weighted Fusion',
                'dynamic': 'Dynamic Routing',
                'visual': 'Visual Only',
                'audio': 'Audio Only',
                'transcription': 'Speech Only'
            };
            return labels[mode] || mode;
        }

        function initializeThumbnails() {
            const videos = document.querySelectorAll('.thumbnail-video');

            videos.forEach(video => {
                const startTime = parseFloat(video.dataset.start);
                const index = video.dataset.index;
                const placeholder = document.getElementById(`placeholder-${index}`);

                video.addEventListener('loadedmetadata', () => {
                    video.currentTime = startTime;
                });

                video.addEventListener('seeked', () => {
                    if (placeholder) {
                        placeholder.classList.add('hidden');
                    }
                });

                video.addEventListener('error', () => {
                    console.log('Video thumbnail failed to load');
                });
            });
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function openVideo(result) {
            if (!result.video_url) {
                alert('Video URL not available');
                return;
            }

            videoPlayer.src = result.video_url;

            videoPlayer.addEventListener('loadedmetadata', function onLoaded() {
                videoPlayer.currentTime = result.start_time;
                videoPlayer.removeEventListener('loadedmetadata', onLoaded);
            });

            const filename = result.s3_uri.split('/').pop() || 'Video';
            modalTitle.textContent = `${filename} - ${formatTime(result.start_time)}`;

            const modalityScoresHtml = Object.entries(result.modality_scores || {})
                .map(([mod, score]) => `<span class="meta-tag ${mod}">${mod}: ${score.toFixed(4)}</span>`)
                .join('');

            const confidenceScore = result.confidence_score !== undefined ? result.confidence_score : result.fusion_score;
            const confidencePercent = Math.round(confidenceScore * 100);

            modalInfo.innerHTML = `
                <span class="meta-tag">Segment: ${result.segment_id}</span>
                <span class="meta-tag">Time: ${formatTime(result.start_time)} - ${formatTime(result.end_time)}</span>
                <span class="meta-tag">Confidence: ${confidencePercent}% (${confidenceScore.toFixed(4)})</span>
                <span class="meta-tag">Fusion: ${result.fusion_score.toFixed(4)}</span>
                ${modalityScoresHtml}
            `;

            videoModal.classList.add('active');
            videoPlayer.play().catch(e => console.log('Autoplay prevented:', e));
        }

        // Close modal
        modalClose.addEventListener('click', closeModal);
        videoModal.addEventListener('click', (e) => {
            if (e.target === videoModal) closeModal();
        });

        function closeModal() {
            videoModal.classList.remove('active');
            videoPlayer.pause();
            videoPlayer.src = '';
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeCodeModal();
            }
            if (e.key === '/' && document.activeElement !== searchInput) {
                e.preventDefault();
                searchInput.focus();
            }
        });

        // Code Inspection Feature
        let searchInputData = null;
        let searchOutputData = null;

        const codeInspectionModal = document.getElementById('codeInspectionModal');
        const showCodeBtn = document.getElementById('showCodeBtn');
        const codeModalClose = document.getElementById('codeModalClose');
        const copyCodeBtn = document.getElementById('copyCodeBtn');
        const exportCodeBtn = document.getElementById('exportCodeBtn');
        const inputPanel = document.getElementById('inputPanel');
        const outputPanel = document.getElementById('outputPanel');
        const inputCode = document.getElementById('inputCode');
        const outputCode = document.getElementById('outputCode');

        // Tab switching
        document.querySelectorAll('.code-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;

                document.querySelectorAll('.code-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                document.querySelectorAll('.code-panel').forEach(p => p.classList.remove('active'));
                document.getElementById(`${tabName}Panel`).classList.add('active');
            });
        });

        // Show code modal
        showCodeBtn.addEventListener('click', () => {
            if (searchInputData && searchOutputData) {
                displayCodeInspection();
                codeInspectionModal.classList.add('active');
            }
        });

        // Close code modal
        codeModalClose.addEventListener('click', closeCodeModal);
        codeInspectionModal.addEventListener('click', (e) => {
            if (e.target === codeInspectionModal) closeCodeModal();
        });

        function closeCodeModal() {
            codeInspectionModal.classList.remove('active');
        }

        // Copy JSON to clipboard
        copyCodeBtn.addEventListener('click', async () => {
            const activeTab = document.querySelector('.code-tab.active').dataset.tab;
            const jsonData = activeTab === 'input' ? searchInputData : searchOutputData;

            try {
                await navigator.clipboard.writeText(JSON.stringify(jsonData, null, 2));
                copyCodeBtn.textContent = 'Copied!';
                setTimeout(() => {
                    copyCodeBtn.textContent = 'Copy JSON';
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
            }
        });

        // Export JSON file
        exportCodeBtn.addEventListener('click', () => {
            const combined = {
                input: searchInputData,
                output: searchOutputData,
                timestamp: new Date().toISOString(),
                mode: currentMode
            };

            const blob = new Blob([JSON.stringify(combined, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `search_results_${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Format JSON with syntax highlighting
        function formatJSON(json) {
            const jsonStr = JSON.stringify(json, null, 2);
            return jsonStr
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"([^"]+)":/g, '<span class="json-key">"$1"</span>:')
                .replace(/: "([^"]*)"/g, ': <span class="json-string">"$1"</span>')
                .replace(/: (-?\d+\.?\d*)/g, ': <span class="json-number">$1</span>')
                .replace(/: (true|false)/g, ': <span class="json-boolean">$1</span>')
                .replace(/: (null)/g, ': <span class="json-null">$1</span>');
        }

        // Display code inspection
        function displayCodeInspection() {
            inputCode.innerHTML = formatJSON(searchInputData);
            outputCode.innerHTML = formatJSON(searchOutputData);
        }

        // Backend and Index Mode Controls
        const backendDropdown = document.getElementById('backendDropdown');
        const indexModeToggle = document.getElementById('indexModeToggle');
        const indexModeIndicator = document.getElementById('indexModeIndicator');
        let selectedBackend = 's3vectors';
        let useMultiIndex = true;

        // Check backend availability on load
        async function checkBackendAvailability() {
            try {
                const response = await fetch('/api/index-mode');
                if (!response.ok) return;

                const data = await response.json();

                if (!data.s3_vectors_available) {
                    selectedBackend = 'mongodb';
                    backendDropdown.value = 'mongodb';
                    useMultiIndex = false;
                    indexModeToggle.checked = false;
                    indexModeToggle.disabled = false;
                    updateIndexModeIndicator();
                    console.log('S3 Vectors not available, defaulting to MongoDB (unified-index, toggle enabled)');
                } else {
                    selectedBackend = 's3vectors';
                    backendDropdown.value = 's3vectors';
                    useMultiIndex = true;
                    indexModeToggle.checked = true;
                    indexModeToggle.disabled = false;
                    updateIndexModeIndicator();
                    console.log('S3 Vectors available, defaulting to multi-index mode (toggle enabled)');
                }
            } catch (error) {
                console.log('Backend availability check failed:', error);
            }
        }

        // Handle backend dropdown change
        backendDropdown.addEventListener('change', () => {
            selectedBackend = backendDropdown.value;

            if (selectedBackend === 'mongodb') {
                useMultiIndex = false;
                indexModeToggle.checked = false;
                indexModeToggle.disabled = false;
                updateIndexModeIndicator();
            } else {
                useMultiIndex = true;
                indexModeToggle.checked = true;
                indexModeToggle.disabled = false;
                updateIndexModeIndicator();
            }

            if (searchInput.value.trim()) {
                performSearch();
            }
        });

        // Handle index mode toggle change
        indexModeToggle.addEventListener('change', () => {
            useMultiIndex = indexModeToggle.checked;
            updateIndexModeIndicator();

            if (searchInput.value.trim()) {
                performSearch();
            }
        });

        // Update index mode indicator text
        function updateIndexModeIndicator() {
            indexModeIndicator.textContent = useMultiIndex ? 'Multi-Index' : 'Unified-Index';
        }

        // Initialize on page load
        checkBackendAvailability();
    </script>
</body>
</html>
