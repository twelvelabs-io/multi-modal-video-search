<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TwelveLabs Marengo - Multi-Modal Video Search</title>
    <link rel="icon" type="image/x-icon" href="/static/images/TL-favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        (function() {
            var saved = localStorage.getItem('strand-dark-mode');
            var theme;
            if (saved !== null) {
                theme = saved === 'true' ? 'dark' : 'light';
            } else {
                theme = 'light';
            }
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
    <style>
        /* =============================================
           Strand Design System — CSS Custom Properties
           Source: packages/strand/tokens/colors.json
           ============================================= */
        :root,
        [data-theme="dark"] {
            /* Backgrounds */
            --bg-body: #1D1C1B;
            --bg-header: #2A2928;
            --bg-surface: #2A2928;
            --bg-surface-hover: #333231;
            --bg-input: #1D1C1B;
            --bg-deep: #1D1C1B;
            --bg-elevated: #333231;
            --bg-card: #333231;

            /* Borders */
            --border: #45423F;
            --border-light: #333231;
            --border-hover: #6B6966;
            --border-focus: #00DC82;

            /* Text */
            --text-primary: #F4F3F3;
            --text-secondary: #9B9895;
            --text-tertiary: #6B6966;
            --text-inverse: #1D1C1B;

            /* Accent — UI green (#00DC82), not brand green (#00FF00) */
            --accent: #00DC82;
            --accent-hover: #00B86E;
            --accent-light: #1A3D2A;
            --accent-muted: rgba(0, 220, 130, 0.15);

            /* Active/Selected in dark mode = Strand white variant (inverse of light mode black) */
            --active-bg: #F4F3F3;
            --active-text: #1D1C1B;

            /* Modality colors (product line) */
            --visual: #6CD5FD;
            --visual-bg: rgba(108, 213, 253, 0.15);
            --audio: #60E21B;
            --audio-bg: rgba(96, 226, 27, 0.15);
            --transcription: #FABA17;
            --transcription-bg: rgba(250, 186, 23, 0.15);

            /* Modality bar fills */
            --visual-fill: #6CD5FD;
            --audio-fill: #60E21B;
            --transcription-fill: #FABA17;

            /* System */
            --error: #E22622;
            --warning: #FABA17;
            --success: #60E21B;
            --info: #6CD5FD;

            /* Misc */
            --overlay: rgba(0, 0, 0, 0.85);
            --card-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            --gradient-brand: linear-gradient(90deg, #60E21B, #FABA17, #FFB0CD);

            /* Toggle */
            --toggle-off: #45423F;
            --toggle-on: #00DC82;

            /* Spinner */
            --spinner-track: #45423F;

            /* Syntax highlighting */
            --syntax-key: #6CD5FD;
            --syntax-string: #60E21B;
            --syntax-number: #FABA17;
            --syntax-boolean: #FFB592;
            --syntax-null: #9B9895;

            /* Layout */
            --sidebar-width: 240px;
            --sidebar-collapsed-width: 56px;
            --header-height: auto;
        }

        [data-theme="light"] {
            --bg-body: #F4F3F3;
            --bg-header: #FFFFFF;
            --bg-surface: #FFFFFF;
            --bg-surface-hover: #ECECEC;
            --bg-input: #FFFFFF;
            --bg-deep: #F4F3F3;
            --bg-elevated: #ECECEC;
            --bg-card: #ECECEC;

            --border: #D3D1CF;
            --border-light: #E8E7E5;
            --border-hover: #9B9895;
            --border-focus: #00DC82;

            --text-primary: #1D1C1B;
            --text-secondary: #6B6966;
            --text-tertiary: #9B9895;
            --text-inverse: #FFFFFF;

            --accent: #00DC82;
            --accent-hover: #00B86E;
            --accent-light: #E8F5E9;
            --accent-muted: rgba(0, 220, 130, 0.1);

            /* Active/Selected in light mode = charcoal */
            --active-bg: #1D1C1B;
            --active-text: #F4F3F3;

            --visual: #366B7F;
            --visual-bg: rgba(108, 213, 253, 0.12);
            --audio: #30710E;
            --audio-bg: rgba(96, 226, 27, 0.12);
            --transcription: #7D5D0C;
            --transcription-bg: rgba(250, 186, 23, 0.12);

            --visual-fill: #6CD5FD;
            --audio-fill: #60E21B;
            --transcription-fill: #FABA17;

            --error: #E22622;
            --warning: #FABA17;
            --success: #60E21B;
            --info: #6CD5FD;

            --overlay: rgba(0, 0, 0, 0.5);
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            --gradient-brand: linear-gradient(90deg, #60E21B, #FABA17, #FFB0CD);

            --toggle-off: #D3D1CF;
            --toggle-on: #00DC82;

            --spinner-track: #D3D1CF;

            --syntax-key: #366B7F;
            --syntax-string: #30710E;
            --syntax-number: #7D5D0C;
            --syntax-boolean: #805B49;
            --syntax-null: #9B9895;
        }

        /* =============================================
           Base Styles — Strand Typography
           ============================================= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--bg-body);
            color: var(--text-primary);
            min-height: 100vh;
            font-size: 14px;
            line-height: 1.5;
            transition: background-color 0.2s ease, color 0.2s ease;
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            grid-template-rows: auto 1fr;
            grid-template-areas:
                "sidebar header"
                "sidebar content";
        }

        body.sidebar-collapsed {
            --sidebar-width: var(--sidebar-collapsed-width);
        }

        body.sidebar-collapsed .sidebar {
            padding: 8px 0;
            justify-content: flex-start;
        }

        /* =============================================
           Sidebar — TwelveLabs Platform Navigation
           ============================================= */
        .sidebar {
            grid-area: sidebar;
            position: sticky;
            top: 0;
            height: 100vh;
            background: var(--bg-header);
            border-right: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 12px 8px;
            transition: background-color 0.2s ease;
            overflow: hidden;
            z-index: 90;
        }

        .sidebar-top {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .sidebar-bottom {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            margin-bottom: 12px;
        }

        .sidebar-logo img {
            height: 24px;
            width: auto;
            object-fit: contain;
        }

        .sidebar-logo .bedrock-logo {
            height: 22px;
        }

        .sidebar-logo .separator {
            width: 1px;
            height: 24px;
            background: var(--border);
            flex-shrink: 0;
        }

        /* Show dark logo on light bg, light logo on dark bg */
        [data-theme="light"] .logo-for-light { display: block; }
        [data-theme="light"] .logo-for-dark { display: none; }
        [data-theme="dark"] .logo-for-light { display: none; }
        [data-theme="dark"] .logo-for-dark { display: block; }

        [data-theme="light"] .sidebar-logo .bedrock-logo {
            filter: brightness(0) saturate(100%);
        }

        .sidebar-section-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: 8px 12px 4px;
            white-space: nowrap;
            overflow: hidden;
            transition: opacity 0.2s ease;
        }

        .sidebar-explore-nav {
            position: relative;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .sidebar-nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 13px;
            font-weight: 500;
            line-height: 20px;
            min-height: 36px;
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
            overflow: hidden;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            font-family: inherit;
            box-sizing: border-box;
        }

        .sidebar-nav-item:hover {
            background: var(--bg-surface-hover);
            color: var(--text-primary);
        }

        .sidebar-nav-item.active {
            background: var(--active-bg);
            color: var(--active-text);
        }

        .sidebar-nav-icon {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
        }

        .sidebar-nav-label {
            overflow: hidden;
            transition: opacity 0.2s ease, width 0.25s ease;
        }

        .sidebar-collapse-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
            overflow: hidden;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            line-height: 20px;
            min-height: 36px;
            box-sizing: border-box;
        }

        .sidebar-collapse-btn:hover {
            background: var(--bg-surface-hover);
            color: var(--text-primary);
        }

        .sidebar-collapse-icon {
            transition: transform 0.25s ease;
        }

        /* Copyright text */
        .sidebar-copyright {
            font-size: 11px;
            color: var(--text-tertiary);
            padding: 8px 12px 4px;
            white-space: nowrap;
            overflow: hidden;
        }

        /* Collapse icon: show X when expanded, hamburger when collapsed */
        .collapse-x { display: block; }
        .collapse-menu { display: none; }
        body.sidebar-collapsed .collapse-x { display: none; }
        body.sidebar-collapsed .collapse-menu { display: block; }

        /* Horse icon for collapsed sidebar */
        .sidebar-logo-horse {
            display: none;
            width: 28px;
            height: 28px;
            flex-shrink: 0;
            color: var(--text-primary);
        }

        /* Collapsed sidebar */
        body.sidebar-collapsed .sidebar-nav-label {
            display: none;
        }

        body.sidebar-collapsed .sidebar-copyright {
            display: none;
        }

        body.sidebar-collapsed .sidebar-logo .separator,
        body.sidebar-collapsed .sidebar-logo .bedrock-logo,
        body.sidebar-collapsed .sidebar-logo .logo-for-light,
        body.sidebar-collapsed .sidebar-logo .logo-for-dark {
            display: none !important;
        }

        body.sidebar-collapsed .sidebar-logo-horse {
            display: block;
        }

        body.sidebar-collapsed .sidebar-top {
            align-items: center;
            width: 100%;
        }

        body.sidebar-collapsed .sidebar-bottom {
            align-items: center;
            width: 100%;
            margin-top: auto;
        }

        body.sidebar-collapsed .sidebar-nav {
            align-items: center;
            width: 100%;
        }

        body.sidebar-collapsed .sidebar-nav-item,
        body.sidebar-collapsed .sidebar-collapse-btn {
            justify-content: center;
            padding: 0;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            margin: 0;
        }

        body.sidebar-collapsed .sidebar-logo {
            justify-content: center;
            padding: 4px 0;
            margin-bottom: 4px;
        }

        body.sidebar-collapsed .sidebar-section-label {
            display: none;
        }

        /* Theme toggle icon — show sun in dark mode, moon in light mode */
        [data-theme="dark"] .theme-icon-sun { display: block; }
        [data-theme="dark"] .theme-icon-moon { display: none; }
        [data-theme="light"] .theme-icon-sun { display: none; }
        [data-theme="light"] .theme-icon-moon { display: block; }

        /* =============================================
           Header — Centered search bar
           ============================================= */
        header {
            grid-area: header;
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--bg-header);
            display: flex;
            flex-direction: column;
            border-bottom: 1px solid var(--border-light);
            transition: background-color 0.2s ease;
        }

        .header-top {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 0 20px;
            height: 56px;
            flex-shrink: 0;
        }

        .header-menu-btn {
            display: none;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px;
            border-radius: 8px;
            align-items: center;
            justify-content: center;
        }

        .header-menu-btn:hover {
            background: var(--bg-surface-hover);
            color: var(--text-primary);
        }

        .header-search {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 640px;
            margin: 0 auto;
            position: relative;
        }

        .header-search-inner {
            flex: 1;
            display: flex;
            align-items: center;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 16px;
            height: 44px;
            overflow: hidden;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .header-search-inner:focus-within {
            border-color: var(--border-focus);
            box-shadow: 0 0 0 2px var(--accent-muted);
        }

        .header-search-input {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
            font-size: 14px;
            outline: none;
            min-width: 0;
            padding: 0 0 0 16px;
            height: 100%;
        }

        .header-search-input::placeholder {
            color: var(--text-tertiary);
        }

        .header-search-actions {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: 4px;
            margin-right: 12px;
        }

        .header-action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4px;
            border-radius: 6px;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .header-action-btn:hover {
            color: var(--text-primary);
        }

        .header-search-submit {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 56px;
            height: 100%;
            background: var(--bg-surface);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            flex-shrink: 0;
            transition: color 0.2s ease;
        }

        .header-search-submit:hover {
            color: var(--text-primary);
        }

        #imagePreview {
            display: none;
            align-items: center;
            gap: 2px;
            margin-left: 4px;
        }

        #imagePreview.active {
            display: flex;
        }

        #previewImg {
            height: 28px;
            width: 28px;
            border-radius: 4px;
            object-fit: cover;
        }

        #removeImage {
            padding: 2px;
            background: var(--error);
            border: none;
            border-radius: 50%;
            color: #fff;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
        }

        #removeImage:hover {
            background: #9D422B;
        }

        .header-filter-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            height: 40px;
            padding: 0 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-elevated);
            color: var(--text-secondary);
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.15s ease;
        }
        .header-filter-btn .filter-chevron {
            transition: transform 0.2s ease;
        }
        .header-filter-btn.active .filter-chevron {
            transform: rotate(180deg);
        }

        .header-filter-btn:hover,
        .header-filter-btn.active {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-muted);
        }

        /* =============================================
           Header Right — Upload, Theme, User
           ============================================= */
        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .header-upload-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 20px 8px 14px;
            border-radius: 12px;
            border: none;
            background: var(--active-bg);
            color: var(--active-text);
            font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: opacity 0.15s;
        }

        .header-upload-btn:hover {
            opacity: 0.85;
        }

        .header-icon-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .header-icon-btn:hover {
            background: var(--bg-surface-hover);
            color: var(--text-primary);
        }

        .header-avatar-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: var(--accent);
            color: var(--text-inverse);
            cursor: pointer;
            transition: opacity 0.15s;
        }

        .header-avatar-btn:hover {
            opacity: 0.85;
        }

        /* =============================================
           Search Options Panel (Filter Dropdown)
           ============================================= */
        .search-options-panel {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            width: 280px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            z-index: 300;
        }

        .search-options-panel.open {
            display: block;
        }

        .search-options-panel-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-light);
        }

        .search-option-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
        }

        .search-option-row + .search-option-row {
            border-top: 1px solid var(--border-light);
        }

        .search-option-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .search-option-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* =============================================
           Category Pills (Search Modes)
           ============================================= */
        .category-pills-row {
            display: flex;
            align-items: center;
            padding: 0 20px 12px;
            gap: 12px;
        }

        .category-pills-center {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }

        .category-pills {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }

        .pills-row-spacer {
            /* Matches .header-right width: 36px + 8px gap + 36px = 80px */
            width: 80px;
            flex-shrink: 0;
        }

        .category-pills::-webkit-scrollbar {
            display: none;
        }

        .decomposition-inline-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            padding: 4px 0;
        }

        .decomposition-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .category-pill {
            padding: 8px 18px;
            border-radius: 12px;
            border: none;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 200ms ease, color 200ms ease, border-radius 200ms ease;
            white-space: nowrap;
            flex-shrink: 0;
            outline: none;
        }

        .category-pill:hover {
            color: var(--text-primary);
            background: var(--bg-surface-hover);
            border-radius: 16px;
        }

        .category-pill.active {
            background: var(--active-bg);
            color: var(--active-text);
            font-weight: 600;
        }

        /* =============================================
           Analyze View — Search within Video
           ============================================= */
        .analyze-view {
            display: flex;
            height: calc(100vh - 56px);
        }

        .analyze-sidebar {
            width: 280px;
            border-right: 1.3px solid var(--border-light);
            display: flex;
            flex-direction: column;
            background: var(--bg-surface);
            flex-shrink: 0;
        }

        .analyze-sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
        }

        .analyze-sidebar-header h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 0;
        }

        .analyze-asset-list {
            overflow-y: auto;
            flex: 1;
            padding: 8px;
        }

        .analyze-folder-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
            color: var(--text-primary);
        }
        .analyze-folder-item:hover { background: var(--bg-surface-hover); }
        .analyze-folder-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-elevated);
            border-radius: 6px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }
        .analyze-folder-info { display: flex; flex-direction: column; gap: 1px; flex: 1; min-width: 0; }
        .analyze-folder-name { font-size: 13px; font-weight: 500; }
        .analyze-folder-count { font-size: 11px; color: var(--text-tertiary); font-family: 'IBM Plex Mono', monospace; }

        .analyze-back-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 12px;
            color: var(--text-tertiary);
            cursor: pointer;
            font-size: 13px;
            border-bottom: 1px solid var(--border-light);
            margin-bottom: 4px;
            transition: color 0.15s;
        }
        .analyze-back-btn:hover { color: var(--text-primary); }

        .analyze-video-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .analyze-video-item:hover { background: var(--bg-surface-hover); }
        .analyze-video-item.active { background: var(--active-bg); color: var(--active-text); }

        .analyze-video-thumb {
            width: 64px;
            height: 36px;
            border-radius: 4px;
            object-fit: cover;
            background: #0f0f0f;
            flex-shrink: 0;
        }

        .analyze-video-name {
            font-size: 13px;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            min-width: 0;
        }

        .analyze-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .analyze-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: var(--text-tertiary);
        }

        .analyze-preview {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-light);
            position: relative;
        }

        .analyze-preview-clear {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            background: transparent;
            color: var(--text-tertiary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }
        .analyze-preview-clear:hover {
            background: var(--bg-surface-hover);
            color: var(--text-primary);
        }

        .analyze-preview-video {
            width: 160px;
            aspect-ratio: 16/9;
            border-radius: 8px;
            object-fit: cover;
            background: #0f0f0f;
        }

        .analyze-preview-info { display: flex; flex-direction: column; gap: 4px; }
        .analyze-preview-name { font-size: 14px; font-weight: 600; }
        .analyze-preview-meta { font-size: 12px; color: var(--text-tertiary); }

        .analyze-results {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .analyze-results-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .analyze-result-card {
            background: var(--bg-surface);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid transparent;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }
        .analyze-result-card:hover {
            transform: translateY(-2px);
            border-color: var(--border-light);
            box-shadow: var(--card-shadow);
        }

        .analyze-result-thumb-wrap {
            position: relative;
            aspect-ratio: 16/9;
            background: #0f0f0f;
            overflow: hidden;
        }
        .analyze-result-thumb-wrap video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .analyze-result-badge {
            position: absolute;
            bottom: 6px;
            right: 6px;
            background: rgba(0,0,0,0.85);
            color: #fff;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'IBM Plex Mono', monospace;
        }
        .analyze-result-confidence {
            position: absolute;
            top: 6px;
            right: 6px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'IBM Plex Mono', monospace;
        }
        .analyze-result-info {
            padding: 8px 10px;
        }
        .analyze-result-title {
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .analyze-input-area {
            display: flex;
            gap: 8px;
            padding: 12px 16px;
            border-top: 1px solid var(--border-light);
        }

        .analyze-input {
            flex: 1;
            padding: 10px 16px;
            border-radius: 24px;
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            outline: none;
        }
        .analyze-input:focus {
            border-color: var(--border-focus);
            box-shadow: 0 0 0 2px var(--accent-muted);
        }

        .analyze-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--active-bg);
            color: var(--active-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: opacity 0.15s;
        }
        .analyze-send-btn:hover { opacity: 0.85; }

        #homeView {
            padding: 24px 32px;
        }

        /* =============================================
           Indexes View
           ============================================= */
        .indexes-breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        .indexes-breadcrumb-link {
            color: var(--text-tertiary);
            cursor: pointer;
            transition: color 0.15s;
        }
        .indexes-breadcrumb-link:hover { color: var(--text-primary); }
        .indexes-breadcrumb-separator { color: var(--text-tertiary); }
        .indexes-breadcrumb-current { font-weight: 600; color: var(--text-primary); }

        .indexes-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        .index-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: var(--bg-surface);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            cursor: pointer;
            transition: border-color 200ms ease, box-shadow 200ms ease, border-radius 200ms ease;
        }
        .index-card:hover {
            border-color: var(--border-hover);
            box-shadow: var(--card-shadow);
            border-radius: 16px;
        }
        .index-card-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-elevated);
            border-radius: 8px;
            color: var(--text-secondary);
            flex-shrink: 0;
        }
        .index-card-info { display: flex; flex-direction: column; gap: 2px; }
        .index-card-name { font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .index-card-meta { font-size: 12px; color: var(--text-tertiary); }
        .index-card-count { font-size: 12px; color: var(--text-secondary); font-family: 'IBM Plex Mono', monospace; }

        .indexes-video-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }
        .index-video-card {
            background: var(--bg-surface);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid transparent;
            cursor: pointer;
            transition: transform 200ms ease, box-shadow 200ms ease, border-color 200ms ease;
        }
        .index-video-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow);
            border-color: var(--border-light);
        }
        .index-video-thumb {
            width: 100%;
            aspect-ratio: 16/9;
            object-fit: cover;
            background: #0f0f0f;
        }
        .index-video-info { padding: 12px; }
        .index-video-name {
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .index-video-segments {
            font-size: 11px;
            color: var(--text-tertiary);
            font-family: 'IBM Plex Mono', monospace;
            margin-top: 4px;
        }

        @media (max-width: 900px) {
            .indexes-grid { grid-template-columns: 1fr; }
            .indexes-video-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* =============================================
           Main Content
           ============================================= */
        main {
            grid-area: content;
            padding: 0;
            overflow-y: auto;
            transition: background-color 0.2s ease;
            border-left: 1.3px solid var(--border-light);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-light);
        }

        .results-count {
            color: var(--text-tertiary);
            font-size: 12px;
        }

        .query-display {
            font-size: 20px;
            color: var(--text-secondary);
        }

        /* =============================================
           Results Grid & Cards — Strand card pattern
           ============================================= */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .result-card {
            background: var(--bg-surface);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            border: 1px solid transparent;
        }

        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow);
            border-color: var(--border-light);
        }

        .thumbnail-container {
            position: relative;
            aspect-ratio: 16/9;
            background: #0f0f0f;
            overflow: hidden;
        }

        .thumbnail-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }

        .thumbnail-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: var(--text-tertiary);
            font-size: 3rem;
            position: absolute;
            top: 0;
            left: 0;
        }

        .thumbnail-placeholder.hidden {
            display: none;
        }

        .play-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 48px;
            height: 48px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .result-card:hover .play-overlay {
            opacity: 1;
        }

        .play-overlay svg {
            width: 20px;
            height: 20px;
            margin-left: 2px;
        }

        .duration-badge {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            font-family: 'IBM Plex Mono', monospace;
        }

        .score-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: var(--accent);
            color: var(--text-inverse);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .rank-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: var(--accent);
            color: var(--text-inverse);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 700;
            min-width: 28px;
            text-align: center;
            font-family: 'IBM Plex Mono', monospace;
        }

        .confidence-badge {
            position: absolute;
            top: 40px;
            right: 8px;
            background: rgba(0, 0, 0, 0.75);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
            font-family: 'IBM Plex Mono', monospace;
        }

        .confidence-value {
            color: #fff;
        }

        .card-info {
            padding: 12px;
        }

        .card-title {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-subtitle {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-bottom: 6px;
        }

        .card-meta {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .meta-tag {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 4px;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 500;
        }

        .meta-tag.visual { background: var(--visual-bg); color: var(--visual); }
        .meta-tag.audio { background: var(--audio-bg); color: var(--audio); }
        .meta-tag.transcription { background: var(--transcription-bg); color: var(--transcription); }

        /* =============================================
           Video Modal — Strand modal pattern
           ============================================= */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            background: var(--bg-surface);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
        }

        .modal-title {
            font-size: 16px;
            font-weight: 500;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            line-height: 1;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            color: var(--text-primary);
            background: var(--bg-elevated);
        }

        .video-container {
            flex: 1;
            min-height: 0;
            background: #000;
            display: flex;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .modal-info {
            padding: 16px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* =============================================
           Loading & Empty States
           ============================================= */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 64px;
            color: var(--text-secondary);
            gap: 16px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--spinner-track);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 64px;
            color: var(--text-tertiary);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* =============================================
           Weights & Dynamic Panels — Strand surface
           ============================================= */
        .weights-panel {
            background: var(--bg-surface);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: none;
            border: 1px solid var(--border-light);
        }

        .weights-panel.active {
            display: block;
        }

        .weights-panel-title {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .weight-row {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 8px;
        }

        .weight-label {
            width: 100px;
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .weight-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 4px;
            border-radius: 4px;
            background: var(--border);
        }

        .weight-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 8px;
            background: var(--accent);
            cursor: pointer;
            transition: transform 0.15s ease;
        }

        .weight-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .weight-value {
            width: 50px;
            text-align: right;
            font-size: 12px;
            color: var(--text-secondary);
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 500;
        }

        .dynamic-weights-panel {
            background: var(--bg-surface);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: none;
            border: 1px solid var(--border-light);
        }

        .dynamic-weights-panel.active {
            display: block;
        }

        .dynamic-weight-bar {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .dynamic-weight-label {
            width: 100px;
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .dynamic-weight-bar-container {
            flex: 1;
            height: 6px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .dynamic-weight-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .dynamic-weight-bar-fill.visual { background: var(--visual-fill); }
        .dynamic-weight-bar-fill.audio { background: var(--audio-fill); }
        .dynamic-weight-bar-fill.transcription { background: var(--transcription-fill); }

        .dynamic-weight-value {
            width: 50px;
            text-align: right;
            font-size: 12px;
            font-weight: 600;
            font-family: 'IBM Plex Mono', monospace;
        }

        .dynamic-weight-value.visual { color: var(--visual); }
        .dynamic-weight-value.audio { color: var(--audio); }
        .dynamic-weight-value.transcription { color: var(--transcription); }

        /* Dominant modality indicator */
        .dominant-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            font-family: 'IBM Plex Mono', monospace;
        }

        .dominant-indicator.visual { background: rgba(108, 213, 253, 0.9); color: #1D1C1B; }
        .dominant-indicator.audio { background: rgba(96, 226, 27, 0.9); color: #1D1C1B; }
        .dominant-indicator.transcription { background: rgba(250, 186, 23, 0.9); color: #1D1C1B; }

        /* Modality score bars in cards */
        .modality-bars {
            display: flex;
            gap: 2px;
            margin-top: 8px;
        }

        .modality-bar {
            flex: 1;
            height: 3px;
            border-radius: 2px;
            background: var(--border);
            overflow: hidden;
        }

        .modality-bar-fill {
            height: 100%;
            transition: width 0.2s ease;
        }

        .modality-bar-fill.visual { background: var(--visual-fill); }
        .modality-bar-fill.audio { background: var(--audio-fill); }
        .modality-bar-fill.transcription { background: var(--transcription-fill); }

        /* =============================================
           Backend, Index, Decomposition Controls (in dropdown)
           ============================================= */
        .backend-dropdown {
            background: var(--bg-elevated);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 4px 8px;
            font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
            font-size: 12px;
            cursor: pointer;
            outline: none;
            transition: all 0.2s ease;
        }

        .backend-dropdown:hover {
            border-color: var(--accent);
        }

        .backend-dropdown:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent-muted);
        }

        .index-mode-indicator {
            font-size: 12px;
            font-weight: 600;
            color: var(--accent);
            font-family: 'IBM Plex Mono', monospace;
        }

        /* =============================================
           Decomposed Queries
           ============================================= */
        .decomposed-queries {
            display: none;
            background: var(--bg-surface);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .decomposed-queries.visible {
            display: block;
        }

        .decomposed-queries-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .decomposed-query-item {
            margin-bottom: 8px;
            padding: 8px 12px;
            background: var(--bg-elevated);
            border-radius: 8px;
        }

        .decomposed-query-item:last-child {
            margin-bottom: 0;
        }

        .decomposed-query-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .decomposed-query-text {
            font-size: 14px;
            color: var(--text-primary);
        }

        /* =============================================
           Toggle Switch — Strand pattern
           ============================================= */
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--toggle-off);
            transition: 0.2s ease;
            border-radius: 12px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: #fff;
            transition: 0.2s ease;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--toggle-on);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .toggle-switch input:not(:checked) + .toggle-slider {
            background-color: var(--toggle-off);
        }

        .toggle-switch input:disabled + .toggle-slider {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Fusion/Single Mode Labels */
        .fusion-label, .single-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .fusion-label {
            background: var(--accent-muted);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .single-label {
            background: transparent;
            color: var(--text-tertiary);
        }

        /* =============================================
           Code Inspection Modal
           ============================================= */
        .code-inspection-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .code-inspection-modal.active {
            display: flex;
        }

        .code-modal-content {
            width: 90%;
            max-width: 1400px;
            height: 80vh;
            background: var(--bg-surface);
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
        }

        .code-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-elevated);
        }

        .code-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .code-modal-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .code-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-surface);
            color: var(--text-secondary);
            font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .code-btn:hover {
            background: var(--bg-surface-hover);
            border-color: var(--border-hover);
            border-radius: 10px;
        }

        .code-btn.primary {
            background: var(--active-bg);
            border-color: var(--active-bg);
            color: var(--active-text);
        }

        .code-btn.primary:hover {
            background: var(--accent);
            color: var(--text-inverse);
            border-radius: 10px;
        }

        .code-modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            line-height: 1;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .code-modal-close:hover {
            color: var(--text-primary);
            background: var(--bg-surface-hover);
        }

        .code-tabs {
            display: flex;
            gap: 0;
            padding: 0 24px;
            border-bottom: 1px solid var(--border-light);
            background: var(--bg-elevated);
        }

        .code-tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .code-tab:hover {
            color: var(--text-primary);
        }

        .code-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .code-content-area {
            flex: 1;
            overflow: auto;
            padding: 24px;
            background: var(--bg-deep);
        }

        .code-panel {
            display: none;
        }

        .code-panel.active {
            display: block;
        }

        .code-block {
            background: var(--bg-body);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 24px;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-secondary);
            overflow-x: auto;
            white-space: pre;
        }

        /* JSON Syntax Highlighting */
        .json-key { color: var(--syntax-key); }
        .json-string { color: var(--syntax-string); }
        .json-number { color: var(--syntax-number); }
        .json-boolean { color: var(--syntax-boolean); }
        .json-null { color: var(--syntax-null); }

        /* =============================================
           Show Code Button (FAB) — Strand black button
           ============================================= */
        .show-code-btn {
            position: fixed;
            bottom: 32px;
            right: 32px;
            padding: 10px 18px;
            background: var(--active-bg);
            border: none;
            border-radius: 12px;
            color: var(--active-text);
            font-family: 'Noto Sans', Helvetica, Arial, sans-serif;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 100;
            display: none;
        }

        .show-code-btn.visible {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .show-code-btn:hover {
            background: var(--accent);
            color: var(--text-inverse);
            border-radius: 16px;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 220, 130, 0.3);
        }

        .show-code-btn svg {
            display: inline-block;
            vertical-align: middle;
        }

        /* =============================================
           Responsive
           ============================================= */
        @media (max-width: 1200px) {
            .results-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 900px) {
            .results-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            body {
                grid-template-columns: 1fr;
                grid-template-areas:
                    "header"
                    "content";
            }

            .sidebar {
                position: fixed;
                left: calc(-1 * var(--sidebar-width));
                top: 0;
                height: 100vh;
                width: var(--sidebar-width) !important;
                z-index: 500;
                transition: left 0.25s ease, background-color 0.2s ease;
            }

            .sidebar.sidebar-mobile-open {
                left: 0;
                box-shadow: 4px 0 24px rgba(0, 0, 0, 0.3);
            }

            .header-menu-btn {
                display: flex;
            }

            header {
                padding: 0 12px;
                gap: 8px;
            }

            .header-search {
                max-width: none;
            }

            .sidebar-logo .separator,
            .sidebar-logo .bedrock-logo {
                display: none;
            }

            main {
                padding: 16px;
            }

            .category-pills-row {
                flex-direction: column;
                align-items: flex-start;
                padding: 0 0 12px 0;
            }

            .decomposition-inline-toggle {
                padding: 0 0 4px 0;
            }

            .results-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }

        @media (max-width: 480px) {
            .category-pill {
                padding: 4px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- =============================================
         Sidebar — TwelveLabs Platform Navigation
         ============================================= -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-top">
            <!-- Logo: TwelveLabs | Bedrock (full) / Horse icon (collapsed) -->
            <div class="sidebar-logo">
                <img src="/static/images/TL-logo-light.png" alt="TwelveLabs" class="logo-for-light">
                <img src="/static/images/TL-logo-dark.png" alt="TwelveLabs" class="logo-for-dark">
                <div class="separator"></div>
                <img src="/static/images/bedrock-logo.png" alt="Amazon Bedrock" class="bedrock-logo">
                <!-- Horse icon shown only when collapsed -->
                <svg class="sidebar-logo-horse" viewBox="0 0 50 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g fill="currentColor"><rect x="10.78" y="12.36" width="15.81" height="2.14" rx="0.63"/><rect x="0" y="12.36" width="8.66" height="2.14" rx="0.63"/><rect x="30.51" y="12.36" width="9.89" height="2.14" rx="0.63"/><rect x="31.93" y="9.28" width="8.47" height="2.15" rx="0.63"/><rect x="41.51" y="9.28" width="6.73" height="2.15" rx="0.63"/><rect x="38.65" y="6.14" width="7.66" height="2.15" rx="0.63"/><rect x="41.08" y="3.07" width="2.24" height="2.15" rx="0.63"/><rect x="18.26" y="27.71" width="3.9" height="2.15" rx="0.63"/><rect x="25.02" y="27.71" width="2.56" height="2.15" rx="0.63"/><rect x="28.74" y="27.71" width="6.88" height="2.15" rx="0.63"/><rect x="32.2" y="24.64" width="2.87" height="2.14" rx="0.63"/><rect x="12.88" y="27.71" width="2.24" height="2.15" rx="0.63"/><rect x="23.29" y="30.78" width="2.24" height="2.15" rx="0.63"/><rect x="21.09" y="33.86" width="2.15" height="2.14" rx="0.63"/><rect x="29.58" y="0" width="2.8" height="2.15" rx="0.63"/><rect x="13.71" y="9.28" width="7.14" height="2.15" rx="0.63"/><rect x="26.96" y="3.07" width="4.32" height="2.15" rx="0.63"/><rect x="24.29" y="6.14" width="6.99" height="2.15" rx="0.63"/><rect x="46.04" y="12.36" width="4.08" height="2.14" rx="0.63"/><rect x="7.52" y="15.43" width="20.15" height="2.15" rx="0.63"/><rect x="25.83" y="21.57" width="7.87" height="2.15" rx="0.63"/><rect x="10.78" y="18.5" width="25.62" height="2.15" rx="0.63"/><rect x="6.85" y="21.57" width="9.52" height="2.15" rx="0.63"/><rect x="15.56" y="24.64" width="3.11" height="2.14" rx="0.63"/><rect x="26.58" y="24.64" width="3.38" height="2.14" rx="0.63"/><rect x="9.79" y="24.64" width="3.17" height="2.14" rx="0.63"/><rect x="30.51" y="15.43" width="8.14" height="2.15" rx="0.63"/><rect x="32.4" y="6.12" width="2.24" height="2.15" rx="0.63"/></g>
                </svg>
            </div>

            <!-- Primary nav -->
            <nav class="sidebar-nav">
                <a href="#" class="sidebar-nav-item active" data-page="home">
                    <svg class="sidebar-nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                        <path d="M12 3L4 9v12h5v-7h6v7h5V9l-8-6z"/>
                    </svg>
                    <span class="sidebar-nav-label">Home</span>
                </a>
                <a href="#" class="sidebar-nav-item" data-page="examples">
                    <svg class="sidebar-nav-icon" width="20" height="20" viewBox="0 0 12.667 12.8438" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9.66699 6.84377C10.5002 6.84385 11.2087 7.13552 11.792 7.71877C12.3752 8.30205 12.6669 9.01056 12.667 9.84377C12.667 10.677 12.3751 11.3855 11.792 11.9688C11.2087 12.552 10.5002 12.8437 9.66699 12.8438C8.83368 12.8438 8.12532 12.5521 7.54199 11.9688C6.95866 11.3854 6.66699 10.6771 6.66699 9.84377C6.66704 9.01054 6.95871 8.30206 7.54199 7.71877C8.12527 7.13562 8.83379 6.84377 9.66699 6.84377ZM3.7334 7.17776C4.61702 7.1778 5.33301 7.89374 5.33301 8.77737V10.9102C5.33301 11.7938 4.61702 12.5107 3.7334 12.5108H1.59961C0.716134 12.5106 0 11.7937 0 10.9102V8.77737C0 7.89384 0.716133 7.17797 1.59961 7.17776H3.7334ZM9.66699 7.84377C9.09598 7.84377 8.64263 8.03232 8.24902 8.42581C7.85541 8.81942 7.66704 9.27274 7.66699 9.84377C7.66699 10.4149 7.85536 10.8681 8.24902 11.2617C8.64268 11.6554 9.09587 11.8438 9.66699 11.8438C10.238 11.8437 10.6914 11.6553 11.085 11.2617C11.4784 10.8681 11.667 10.4148 11.667 9.84377C11.6669 9.27276 11.4785 8.81941 11.085 8.42581C10.6914 8.03221 10.238 7.84385 9.66699 7.84377ZM1.59961 8.17776C1.26842 8.17797 1 8.44613 1 8.77737V10.9102C1 11.2414 1.26842 11.5106 1.59961 11.5108H3.7334C4.06474 11.5107 4.33301 11.2415 4.33301 10.9102V8.77737C4.33301 8.44602 4.06474 8.1778 3.7334 8.17776H1.59961ZM5.54492 0.254908C5.75293 -0.0849695 6.24707 -0.084969 6.45508 0.254908L9.1709 4.69924C9.38799 5.05459 9.13222 5.51068 8.71582 5.51077H3.28418C2.86778 5.51068 2.61201 5.05459 2.8291 4.69924L5.54492 0.254908ZM4.11621 4.51077H7.88379L6 1.42874L4.11621 4.51077Z"/>
                    </svg>
                    <span class="sidebar-nav-label">Examples</span>
                </a>
                <a href="#" class="sidebar-nav-item" data-page="indexes">
                    <svg class="sidebar-nav-icon" width="20" height="20" viewBox="0 0 12 10" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M11 8.66667V2.58333C11 2.39924 10.8508 2.25 10.6667 2.25H6.41756C5.9418 2.25 5.47741 2.10457 5.08664 1.8332L3.97257 1.05954C3.91675 1.02078 3.85041 1 3.78244 1H1.33333C1.14924 1 1 1.14924 1 1.33333V8.66667C1 8.85076 1.14924 9 1.33333 9H10.6667C10.8508 9 11 8.85076 11 8.66667ZM12 8.66667V2.58333C12 1.84695 11.403 1.25 10.6667 1.25H6.41756C6.1457 1.25 5.88033 1.1669 5.65703 1.01183L4.54297 0.238173C4.31967 0.0831044 4.0543 0 3.78244 0H1.33333C0.596955 0 0 0.596954 0 1.33333V8.66667C0 9.40305 0.596954 10 1.33333 10H10.6667C11.403 10 12 9.40305 12 8.66667Z"/>
                    </svg>
                    <span class="sidebar-nav-label">Indexes</span>
                </a>
            </nav>

            <!-- Explore section -->
            <div class="sidebar-section-label">EXPLORE</div>
            <nav class="sidebar-nav sidebar-explore-nav">
                <a href="#" class="sidebar-nav-item" data-page="analyze">
                    <svg class="sidebar-nav-icon" width="20" height="20" viewBox="0 0 12 12" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M5 0C7.76142 0 10 2.23858 10 5C10 6.01926 9.69399 6.9672 9.16888 7.7545L11.7071 10.2929C12.0976 10.6834 12.0976 11.3166 11.7071 11.7071C11.3166 12.0976 10.6834 12.0976 10.2929 11.7071L7.7545 9.16888C6.9672 9.69399 6.01926 10 5 10C2.23858 10 0 7.76142 0 5C0 2.23858 2.23858 0 5 0ZM5 1C2.79086 1 1 2.79086 1 5C1 7.20914 2.79086 9 5 9C7.20914 9 9 7.20914 9 5C9 2.79086 7.20914 1 5 1ZM3.5 4C3.77614 4 4 4.22386 4 4.5V7C4 7.27614 3.77614 7.5 3.5 7.5C3.22386 7.5 3 7.27614 3 7V4.5C3 4.22386 3.22386 4 3.5 4ZM5 3C5.27614 3 5.5 3.22386 5.5 3.5V7C5.5 7.27614 5.27614 7.5 5 7.5C4.72386 7.5 4.5 7.27614 4.5 7V3.5C4.5 3.22386 4.72386 3 5 3ZM6.5 5C6.77614 5 7 5.22386 7 5.5V7C7 7.27614 6.77614 7.5 6.5 7.5C6.22386 7.5 6 7.27614 6 7V5.5C6 5.22386 6.22386 5 6.5 5Z"/>
                    </svg>
                    <span class="sidebar-nav-label">Analyze</span>
                </a>
            </nav>
        </div>

        <div class="sidebar-bottom">
            <!-- Copyright -->
            <div class="sidebar-copyright">&copy; 2026 TwelveLabs, Inc.</div>
            <!-- Collapse: X when expanded, hamburger when collapsed -->
            <button class="sidebar-collapse-btn" id="sidebarCollapseBtn" title="Collapse sidebar">
                <svg class="sidebar-nav-icon sidebar-collapse-icon collapse-x" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
                <svg class="sidebar-nav-icon sidebar-collapse-icon collapse-menu" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
                <span class="sidebar-nav-label">Collapse</span>
            </button>
        </div>
    </aside>

    <!-- =============================================
         Header — Search bar + filter
         ============================================= -->
    <header>
        <div class="header-top">
        <!-- Hamburger for mobile -->
        <button class="header-menu-btn" id="headerMenuBtn" title="Toggle sidebar">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>

        <!-- Search bar -->
        <div class="header-search">
            <div class="header-search-inner">
                <input type="text" class="header-search-input" id="searchInput" placeholder="Search videos...">
                <div class="header-search-actions">
                    <label for="imageUpload" class="header-action-btn" title="Upload image for search">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                    </label>
                    <input type="file" id="imageUpload" accept="image/jpeg,image/png,image/gif,image/webp" style="display: none;">
                    <div id="imagePreview">
                        <img id="previewImg" alt="Query image preview">
                        <button id="removeImage" title="Remove image" type="button">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                </div>
                <button class="header-search-submit" id="searchBtn" title="Search">
                    <svg width="18" height="18" viewBox="0 0 12 11.707" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M7.5 0C9.98528 0 12 2.01472 12 4.5C12 6.98528 9.98528 9 7.5 9C6.36252 8.99998 5.32451 8.57691 4.53223 7.88086L0.707031 11.707L0 11L3.85742 7.1416C3.31847 6.39969 3 5.48716 3 4.5C3 2.01474 5.01475 4.07169e-05 7.5 0ZM7.5 1C5.56704 1.00004 4 2.56703 4 4.5C4 6.43297 5.56704 7.99996 7.5 8C9.433 8 11 6.433 11 4.5C11 2.567 9.433 1 7.5 1Z"/>
                    </svg>
                </button>
            </div>

            <!-- Filter button -->
            <button class="header-filter-btn" id="filterBtn" title="Search options">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round">
                    <line x1="2" y1="4" x2="14" y2="4"/>
                    <line x1="2" y1="8" x2="14" y2="8"/>
                    <line x1="2" y1="12" x2="14" y2="12"/>
                    <circle cx="5" cy="4" r="1.5" fill="currentColor" stroke="none"/>
                    <circle cx="10" cy="8" r="1.5" fill="currentColor" stroke="none"/>
                    <circle cx="7" cy="12" r="1.5" fill="currentColor" stroke="none"/>
                </svg>
                <svg class="filter-chevron" width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 5l3 3 3-3"/>
                </svg>
            </button>

            <!-- Search Options Dropdown Panel -->
            <div class="search-options-panel" id="searchOptionsPanel">
                <div class="search-options-panel-title">Search Configuration</div>
                <div class="search-option-row">
                    <span class="search-option-label">Vector DB</span>
                    <select class="backend-dropdown" id="backendDropdown" title="Choose vector database backend">
                        <option value="s3vectors">S3 Vectors</option>
                        <option value="mongodb">MongoDB</option>
                    </select>
                </div>
                <div class="search-option-row">
                    <span class="search-option-label">Index Mode</span>
                    <div class="search-option-right">
                        <span class="index-mode-indicator" id="indexModeIndicator">Multi-Index</span>
                        <label class="toggle-switch" title="Toggle between Unified-Index and Multi-Index">
                            <input type="checkbox" id="indexModeToggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Header right: Upload, Theme toggle, User avatar -->
        <div class="header-right">
            <button class="header-icon-btn" id="themeToggle" title="Toggle theme">
                <svg class="theme-icon-sun" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
                <svg class="theme-icon-moon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
            <button class="header-avatar-btn" id="userAvatarBtn" title="User profile">
                <svg width="16" height="16" viewBox="0 0 13 11.3333" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M6.50065 4.33333C7.42113 4.33333 8.16732 3.58714 8.16732 2.66667C8.16732 1.74619 7.42113 1 6.50065 1C5.58018 1 4.83398 1.74619 4.83398 2.66667C4.83398 3.58714 5.58018 4.33333 6.50065 4.33333ZM6.50065 5.33333C7.97341 5.33333 9.16732 4.13943 9.16732 2.66667C9.16732 1.19391 7.97341 0 6.50065 0C5.02789 0 3.83398 1.19391 3.83398 2.66667C3.83398 4.13943 5.02789 5.33333 6.50065 5.33333Z"/>
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M0 9.33331C0 7.58441 1.41777 6.16665 3.16667 6.16665H9.83333C11.5822 6.16665 13 7.58441 13 9.33331V11.3333H12V9.33331C12 8.1367 11.03 7.16665 9.83333 7.16665H3.16667C1.97005 7.16665 1 8.1367 1 9.33331V11.3333H0V9.33331Z"/>
                </svg>
            </button>
        </div>
        </div><!-- /header-top -->

        <!-- Category pills (search modes) + LLM decomposition toggle -->
        <div class="category-pills-row">
            <div class="category-pills-center">
                <div class="category-pills" id="categoryPills">
                    <button class="category-pill" data-mode="fused" title="Simple fusion with fixed default weights (visual=0.8, audio=0.1, transcription=0.05)">Fused</button>
                    <button class="category-pill" data-mode="rrf" title="Multi-vector fusion using Reciprocal Rank Fusion">RRF</button>
                    <button class="category-pill" data-mode="weighted" title="Multi-vector fusion with adjustable weighted score combination">Weighted</button>
                    <button class="category-pill active" data-mode="dynamic" title="Multi-vector fusion with dynamic intent routing">Dynamic</button>
                    <button class="category-pill" data-mode="visual" title="Search visual content only">Visual</button>
                    <button class="category-pill" data-mode="audio" title="Search audio/sound only">Audio</button>
                    <button class="category-pill" data-mode="transcription" title="Search speech/transcription only">Speech</button>
                </div>
                <div class="decomposition-inline-toggle" id="decompositionToggleContainer">
                    <span class="decomposition-label">LLM Decomposition</span>
                    <label class="toggle-switch" title="Use Claude Haiku to decompose queries per modality">
                        <input type="checkbox" id="decompositionToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
            <div class="pills-row-spacer"></div>
        </div>
    </header>

    <!-- =============================================
         Main Content
         ============================================= -->
    <main>
        <div id="homeView">

        <!-- Fused mode: fixed weights info -->
        <div class="weights-panel active" id="fusedPanel">
            <div class="weights-panel-title">Fused Embeddings (Fixed Weights)</div>
            <div class="weight-row">
                <span class="weight-label">Visual</span>
                <div style="flex: 1; height: 4px; background: var(--border); border-radius: 4px; overflow: hidden;">
                    <div style="width: 80%; height: 100%; background: var(--visual-fill);"></div>
                </div>
                <span class="weight-value">0.80</span>
            </div>
            <div class="weight-row">
                <span class="weight-label">Audio</span>
                <div style="flex: 1; height: 4px; background: var(--border); border-radius: 4px; overflow: hidden;">
                    <div style="width: 10%; height: 100%; background: var(--audio-fill);"></div>
                </div>
                <span class="weight-value">0.10</span>
            </div>
            <div class="weight-row">
                <span class="weight-label">Transcription</span>
                <div style="flex: 1; height: 4px; background: var(--border); border-radius: 4px; overflow: hidden;">
                    <div style="width: 5%; height: 100%; background: var(--transcription-fill);"></div>
                </div>
                <span class="weight-value">0.05</span>
            </div>
        </div>

        <!-- Weighted mode: manual sliders -->
        <div class="weights-panel" id="weightsPanel">
            <div class="weights-panel-title">Adjust Modality Weights</div>
            <div class="weight-row">
                <span class="weight-label">Visual</span>
                <input type="range" class="weight-slider" id="visualWeight" min="0" max="100" value="80">
                <span class="weight-value" id="visualValue">0.80</span>
            </div>
            <div class="weight-row">
                <span class="weight-label">Audio</span>
                <input type="range" class="weight-slider" id="audioWeight" min="0" max="100" value="10">
                <span class="weight-value" id="audioValue">0.10</span>
            </div>
            <div class="weight-row">
                <span class="weight-label">Transcription</span>
                <input type="range" class="weight-slider" id="transcriptionWeight" min="0" max="100" value="5">
                <span class="weight-value" id="transcriptionValue">0.05</span>
            </div>
        </div>

        <!-- Dynamic mode: auto-computed weights display -->
        <div class="dynamic-weights-panel" id="dynamicWeightsPanel">
            <div class="weights-panel-title">Auto-Computed Weights (based on query intent)</div>
            <div class="dynamic-weight-bar">
                <span class="dynamic-weight-label">Visual</span>
                <div class="dynamic-weight-bar-container">
                    <div class="dynamic-weight-bar-fill visual" id="dynamicVisualBar" style="width: 0%"></div>
                </div>
                <span class="dynamic-weight-value visual" id="dynamicVisualValue">-</span>
            </div>
            <div class="dynamic-weight-bar">
                <span class="dynamic-weight-label">Audio</span>
                <div class="dynamic-weight-bar-container">
                    <div class="dynamic-weight-bar-fill audio" id="dynamicAudioBar" style="width: 0%"></div>
                </div>
                <span class="dynamic-weight-value audio" id="dynamicAudioValue">-</span>
            </div>
            <div class="dynamic-weight-bar">
                <span class="dynamic-weight-label">Transcription</span>
                <div class="dynamic-weight-bar-container">
                    <div class="dynamic-weight-bar-fill transcription" id="dynamicTranscriptionBar" style="width: 0%"></div>
                </div>
                <span class="dynamic-weight-value transcription" id="dynamicTranscriptionValue">-</span>
            </div>
        </div>

        <!-- RRF mode info -->
        <div class="weights-panel" id="rrfPanel">
            <div class="weights-panel-title">Reciprocal Rank Fusion (RRF) — Equal Modality Ranking</div>
            <div class="weight-row">
                <span class="weight-label">Visual</span>
                <div style="flex: 1; height: 4px; background: var(--border); border-radius: 4px; overflow: hidden;">
                    <div style="width: 33%; height: 100%; background: var(--visual-fill);"></div>
                </div>
                <span class="weight-value">1/3</span>
            </div>
            <div class="weight-row">
                <span class="weight-label">Audio</span>
                <div style="flex: 1; height: 4px; background: var(--border); border-radius: 4px; overflow: hidden;">
                    <div style="width: 33%; height: 100%; background: var(--audio-fill);"></div>
                </div>
                <span class="weight-value">1/3</span>
            </div>
            <div class="weight-row">
                <span class="weight-label">Transcription</span>
                <div style="flex: 1; height: 4px; background: var(--border); border-radius: 4px; overflow: hidden;">
                    <div style="width: 33%; height: 100%; background: var(--transcription-fill);"></div>
                </div>
                <span class="weight-value">1/3</span>
            </div>
        </div>

        <!-- Decomposed Queries Display -->
        <div class="decomposed-queries" id="decomposedQueriesDisplay">
            <div class="decomposed-queries-title">
                Original Query: <span id="originalQueryText"></span>
            </div>
            <div class="decomposed-query-item">
                <div class="decomposed-query-label">Visual Query:</div>
                <div class="decomposed-query-text" id="visualQueryText"></div>
            </div>
            <div class="decomposed-query-item">
                <div class="decomposed-query-label">Audio Query:</div>
                <div class="decomposed-query-text" id="audioQueryText"></div>
            </div>
            <div class="decomposed-query-item">
                <div class="decomposed-query-label">Transcription Query:</div>
                <div class="decomposed-query-text" id="transcriptionQueryText"></div>
            </div>
        </div>

        <div class="results-header">
            <div>
                <span class="query-display" id="queryDisplay"></span>
                <span class="results-count" id="resultsCount"></span>
            </div>
        </div>

        <div id="resultsContainer">
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <p>Enter a search query to find video segments</p>
            </div>
        </div>
        </div><!-- /homeView -->

        <!-- Analyze View — Search within Video -->
        <div id="analyzeView" class="analyze-view" style="display: none;">
            <!-- Left: Asset Selector -->
            <div class="analyze-sidebar">
                <div class="analyze-sidebar-header">
                    <h3 id="analyzeSidebarTitle">Select Asset</h3>
                </div>
                <div class="analyze-asset-list" id="analyzeAssetList">
                    <!-- Populated by JS: folders or video list -->
                </div>
            </div>

            <!-- Right: Prompt + Results -->
            <div class="analyze-main">
                <!-- Selected video preview (shown when a video is selected) -->
                <div class="analyze-preview" id="analyzePreview" style="display: none;">
                    <video class="analyze-preview-video" id="analyzePreviewVideo" muted preload="metadata"></video>
                    <div class="analyze-preview-info">
                        <div class="analyze-preview-name" id="analyzePreviewName"></div>
                        <div class="analyze-preview-meta" id="analyzePreviewMeta"></div>
                    </div>
                    <button class="analyze-preview-clear" id="analyzeClearVideo" title="Clear selection">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>

                <!-- Results area -->
                <div class="analyze-results" id="analyzeResults">
                    <div class="analyze-empty">
                        <svg width="48" height="48" viewBox="0 0 12 12" fill="currentColor" style="opacity: 0.15;">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M5 0C7.76142 0 10 2.23858 10 5C10 6.01926 9.69399 6.9672 9.16888 7.7545L11.7071 10.2929C12.0976 10.6834 12.0976 11.3166 11.7071 11.7071C11.3166 12.0976 10.6834 12.0976 10.2929 11.7071L7.7545 9.16888C6.9672 9.69399 6.01926 10 5 10C2.23858 10 0 7.76142 0 5C0 2.23858 2.23858 0 5 0ZM5 1C2.79086 1 1 2.79086 1 5C1 7.20914 2.79086 9 5 9C7.20914 9 9 7.20914 9 5C9 2.79086 7.20914 1 5 1ZM3.5 4C3.77614 4 4 4.22386 4 4.5V7C4 7.27614 3.77614 7.5 3.5 7.5C3.22386 7.5 3 7.27614 3 7V4.5C3 4.22386 3.22386 4 3.5 4ZM5 3C5.27614 3 5.5 3.22386 5.5 3.5V7C5.5 7.27614 5.27614 7.5 5 7.5C4.72386 7.5 4.5 7.27614 4.5 7V3.5C4.5 3.22386 4.72386 3 5 3ZM6.5 5C6.77614 5 7 5.22386 7 5.5V7C7 7.27614 6.77614 7.5 6.5 7.5C6.22386 7.5 6 7.27614 6 7V5.5C6 5.22386 6.22386 5 6.5 5Z"/>
                        </svg>
                        <p>Chat with your videos, or select one from the left to filter</p>
                    </div>
                </div>

                <!-- Prompt input (always visible) -->
                <div class="analyze-input-area">
                    <input type="text" class="analyze-input" id="analyzeInput" placeholder="Chat with your videos...">
                    <button class="analyze-send-btn" id="analyzeSendBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Indexes View -->
        <div id="indexesView" style="display: none; padding: 24px 32px;">
            <!-- Breadcrumb -->
            <div class="indexes-breadcrumb" id="indexesBreadcrumb">
                <span class="indexes-breadcrumb-current">Indexes</span>
            </div>

            <!-- Folder Grid (default view) -->
            <div id="indexesListView">
                <div class="indexes-grid">
                    <div class="index-card" data-backend="mongodb" data-mode="unified">
                        <div class="index-card-icon">
                            <svg width="20" height="20" viewBox="0 0 12 10" fill="currentColor">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M11 8.66667V2.58333C11 2.39924 10.8508 2.25 10.6667 2.25H6.41756C5.9418 2.25 5.47741 2.10457 5.08664 1.8332L3.97257 1.05954C3.91675 1.02078 3.85041 1 3.78244 1H1.33333C1.14924 1 1 1.14924 1 1.33333V8.66667C1 8.85076 1.14924 9 1.33333 9H10.6667C10.8508 9 11 8.85076 11 8.66667ZM12 8.66667V2.58333C12 1.84695 11.403 1.25 10.6667 1.25H6.41756C6.1457 1.25 5.88033 1.1669 5.65703 1.01183L4.54297 0.238173C4.31967 0.0831044 4.0543 0 3.78244 0H1.33333C0.596955 0 0 0.596954 0 1.33333V8.66667C0 9.40305 0.596954 10 1.33333 10H10.6667C11.403 10 12 9.40305 12 8.66667Z"/>
                            </svg>
                        </div>
                        <div class="index-card-info">
                            <span class="index-card-name">MongoDB — Unified</span>
                            <span class="index-card-meta">Single-index, all modalities</span>
                            <span class="index-card-count" id="countMongoUnified">— videos</span>
                        </div>
                    </div>
                    <div class="index-card" data-backend="mongodb" data-mode="multi">
                        <div class="index-card-icon">
                            <svg width="20" height="20" viewBox="0 0 12 10" fill="currentColor">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M11 8.66667V2.58333C11 2.39924 10.8508 2.25 10.6667 2.25H6.41756C5.9418 2.25 5.47741 2.10457 5.08664 1.8332L3.97257 1.05954C3.91675 1.02078 3.85041 1 3.78244 1H1.33333C1.14924 1 1 1.14924 1 1.33333V8.66667C1 8.85076 1.14924 9 1.33333 9H10.6667C10.8508 9 11 8.85076 11 8.66667ZM12 8.66667V2.58333C12 1.84695 11.403 1.25 10.6667 1.25H6.41756C6.1457 1.25 5.88033 1.1669 5.65703 1.01183L4.54297 0.238173C4.31967 0.0831044 4.0543 0 3.78244 0H1.33333C0.596955 0 0 0.596954 0 1.33333V8.66667C0 9.40305 0.596954 10 1.33333 10H10.6667C11.403 10 12 9.40305 12 8.66667Z"/>
                            </svg>
                        </div>
                        <div class="index-card-info">
                            <span class="index-card-name">MongoDB — Multi</span>
                            <span class="index-card-meta">Per-modality indexes</span>
                            <span class="index-card-count" id="countMongoMulti">— videos</span>
                        </div>
                    </div>
                    <div class="index-card" data-backend="s3vectors" data-mode="unified">
                        <div class="index-card-icon">
                            <svg width="20" height="20" viewBox="0 0 12 10" fill="currentColor">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M11 8.66667V2.58333C11 2.39924 10.8508 2.25 10.6667 2.25H6.41756C5.9418 2.25 5.47741 2.10457 5.08664 1.8332L3.97257 1.05954C3.91675 1.02078 3.85041 1 3.78244 1H1.33333C1.14924 1 1 1.14924 1 1.33333V8.66667C1 8.85076 1.14924 9 1.33333 9H10.6667C10.8508 9 11 8.85076 11 8.66667ZM12 8.66667V2.58333C12 1.84695 11.403 1.25 10.6667 1.25H6.41756C6.1457 1.25 5.88033 1.1669 5.65703 1.01183L4.54297 0.238173C4.31967 0.0831044 4.0543 0 3.78244 0H1.33333C0.596955 0 0 0.596954 0 1.33333V8.66667C0 9.40305 0.596954 10 1.33333 10H10.6667C11.403 10 12 9.40305 12 8.66667Z"/>
                            </svg>
                        </div>
                        <div class="index-card-info">
                            <span class="index-card-name">S3 Vectors — Unified</span>
                            <span class="index-card-meta">Single-index, all modalities</span>
                            <span class="index-card-count" id="countS3Unified">— videos</span>
                        </div>
                    </div>
                    <div class="index-card" data-backend="s3vectors" data-mode="multi">
                        <div class="index-card-icon">
                            <svg width="20" height="20" viewBox="0 0 12 10" fill="currentColor">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M11 8.66667V2.58333C11 2.39924 10.8508 2.25 10.6667 2.25H6.41756C5.9418 2.25 5.47741 2.10457 5.08664 1.8332L3.97257 1.05954C3.91675 1.02078 3.85041 1 3.78244 1H1.33333C1.14924 1 1 1.14924 1 1.33333V8.66667C1 8.85076 1.14924 9 1.33333 9H10.6667C10.8508 9 11 8.85076 11 8.66667ZM12 8.66667V2.58333C12 1.84695 11.403 1.25 10.6667 1.25H6.41756C6.1457 1.25 5.88033 1.1669 5.65703 1.01183L4.54297 0.238173C4.31967 0.0831044 4.0543 0 3.78244 0H1.33333C0.596955 0 0 0.596954 0 1.33333V8.66667C0 9.40305 0.596954 10 1.33333 10H10.6667C11.403 10 12 9.40305 12 8.66667Z"/>
                            </svg>
                        </div>
                        <div class="index-card-info">
                            <span class="index-card-name">S3 Vectors — Multi</span>
                            <span class="index-card-meta">Per-modality indexes</span>
                            <span class="index-card-count" id="countS3Multi">— videos</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Video List (shown when a folder is opened) -->
            <div id="indexesDetailView" style="display: none;">
                <div class="indexes-video-grid" id="indexesVideoGrid"></div>
            </div>
        </div>
    </main>

    <!-- Video Modal -->
    <div class="modal" id="videoModal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">Video Playback</span>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="video-container">
                <video id="videoPlayer" controls preload="auto"></video>
            </div>
            <div class="modal-info" id="modalInfo"></div>
        </div>
    </div>

    <!-- Code Inspection Modal -->
    <div class="code-inspection-modal" id="codeInspectionModal">
        <div class="code-modal-content">
            <div class="code-modal-header">
                <span class="code-modal-title">Search Code Inspection</span>
                <div class="code-modal-actions">
                    <button class="code-btn" id="copyCodeBtn">Copy JSON</button>
                    <button class="code-btn primary" id="exportCodeBtn">Export JSON</button>
                    <button class="code-modal-close" id="codeModalClose">&times;</button>
                </div>
            </div>
            <div class="code-tabs">
                <button class="code-tab active" data-tab="input">Input</button>
                <button class="code-tab" data-tab="output">Output</button>
            </div>
            <div class="code-content-area">
                <div class="code-panel active" id="inputPanel">
                    <pre class="code-block" id="inputCode"></pre>
                </div>
                <div class="code-panel" id="outputPanel">
                    <pre class="code-block" id="outputCode"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Show Code Button (floating) -->
    <button class="show-code-btn" id="showCodeBtn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="16 18 22 12 16 6"></polyline>
            <polyline points="8 6 2 12 8 18"></polyline>
        </svg>
        Show Code
    </button>

    <script>
        // =============================================
        // Theme Toggle
        // =============================================
        const themeToggle = document.getElementById('themeToggle');

        themeToggle.addEventListener('click', () => {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('strand-dark-mode', String(next === 'dark'));
        });

        // Listen for system preference changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (localStorage.getItem('strand-dark-mode') === null) {
                document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
            }
        });

        // =============================================
        // Sidebar Collapse/Expand
        // =============================================
        const sidebar = document.getElementById('sidebar');
        const sidebarCollapseBtn = document.getElementById('sidebarCollapseBtn');
        const headerMenuBtn = document.getElementById('headerMenuBtn');

        // Restore saved state
        if (localStorage.getItem('sidebar-collapsed') === 'true') {
            document.body.classList.add('sidebar-collapsed');
        }

        sidebarCollapseBtn.addEventListener('click', () => {
            document.body.classList.toggle('sidebar-collapsed');
            localStorage.setItem('sidebar-collapsed', String(document.body.classList.contains('sidebar-collapsed')));
        });

        // Mobile sidebar toggle
        headerMenuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('sidebar-mobile-open');
        });

        // Close sidebar on outside click (mobile)
        document.addEventListener('click', (e) => {
            if (window.innerWidth <= 768) {
                if (!sidebar.contains(e.target) && !headerMenuBtn.contains(e.target)) {
                    sidebar.classList.remove('sidebar-mobile-open');
                }
            }
        });

        // =============================================
        // Filter Panel Toggle
        // =============================================
        const filterBtn = document.getElementById('filterBtn');
        const searchOptionsPanel = document.getElementById('searchOptionsPanel');

        filterBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            searchOptionsPanel.classList.toggle('open');
            filterBtn.classList.toggle('active');
        });

        document.addEventListener('click', (e) => {
            if (!searchOptionsPanel.contains(e.target) && !filterBtn.contains(e.target)) {
                searchOptionsPanel.classList.remove('open');
                filterBtn.classList.remove('active');
            }
        });

        // =============================================
        // EXAMPLE QUERIES — Edit this array to change preset searches
        // =============================================
        const EXAMPLE_QUERIES = [
            'Ross says I take thee Rachel at a wedding',
            'Pennywise dancing in sewer saying we all float',
            'a player is executing a triple kill in league of legends',
            'Enthusiastic audience watching a tournament with powerful, emotional background music',
        ];
        let exampleQueryIndex = 0;

        // =============================================
        // State
        // =============================================
        let currentMode = 'dynamic';
        let currentResults = [];
        let preloadedVideoUrl = null;
        let lastDynamicWeights = null;
        let useDecomposition = true;
        let lastDecomposedQueries = null;

        // DOM Elements
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const resultsContainer = document.getElementById('resultsContainer');
        const queryDisplay = document.getElementById('queryDisplay');
        const resultsCount = document.getElementById('resultsCount');
        const fusedPanel = document.getElementById('fusedPanel');
        const weightsPanel = document.getElementById('weightsPanel');
        const dynamicWeightsPanel = document.getElementById('dynamicWeightsPanel');
        const rrfPanel = document.getElementById('rrfPanel');
        const videoModal = document.getElementById('videoModal');
        const videoPlayer = document.getElementById('videoPlayer');
        const modalTitle = document.getElementById('modalTitle');
        const modalInfo = document.getElementById('modalInfo');
        const modalClose = document.getElementById('modalClose');
        const decompositionToggle = document.getElementById('decompositionToggle');
        const decompositionToggleContainer = document.getElementById('decompositionToggleContainer');
        const decomposedQueriesDisplay = document.getElementById('decomposedQueriesDisplay');

        // Multi-vector modes that use all modalities
        const MULTI_VECTOR_MODES = ['fused', 'rrf', 'weighted', 'dynamic'];

        // Modes that support LLM decomposition (excludes Fused and SINGLE modes)
        const DECOMPOSITION_MODES = ['rrf', 'weighted', 'dynamic'];

        // Image Upload Elements
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const removeImage = document.getElementById('removeImage');
        let currentImageBase64 = null;

        // Image Upload Handler
        imageUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 5 * 1024 * 1024) {
                alert('Image must be less than 5MB');
                e.target.value = '';
                return;
            }

            const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                alert('Please upload a JPEG, PNG, GIF, or WebP image');
                e.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const base64Data = event.target.result.split(',')[1];
                currentImageBase64 = base64Data;
                previewImg.src = event.target.result;
                imagePreview.classList.add('active');
                imagePreview.style.display = 'flex';
            };
            reader.readAsDataURL(file);
        });

        // Remove Image Handler
        removeImage.addEventListener('click', function() {
            currentImageBase64 = null;
            imageUpload.value = '';
            imagePreview.classList.remove('active');
            imagePreview.style.display = 'none';
            previewImg.src = '';
        });

        // Update panel visibility based on mode
        function updatePanelVisibility() {
            fusedPanel.classList.toggle('active', currentMode === 'fused');
            weightsPanel.classList.toggle('active', currentMode === 'weighted');
            dynamicWeightsPanel.classList.toggle('active', currentMode === 'dynamic');
            rrfPanel.classList.toggle('active', currentMode === 'rrf');

            const supportsDecomposition = DECOMPOSITION_MODES.includes(currentMode);
            decompositionToggleContainer.style.opacity = supportsDecomposition ? '1' : '0.4';
            decompositionToggleContainer.style.pointerEvents = supportsDecomposition ? 'auto' : 'none';
            decompositionToggle.disabled = !supportsDecomposition;

            if (!supportsDecomposition) {
                decomposedQueriesDisplay.classList.remove('visible');
            }
        }

        // Update dynamic weights display
        function updateDynamicWeightsDisplay(weights) {
            if (!weights) return;
            lastDynamicWeights = weights;

            ['visual', 'audio', 'transcription'].forEach(modality => {
                const value = weights[modality] || 0;
                const percentage = (value * 100).toFixed(1);
                document.getElementById(`dynamic${capitalize(modality)}Bar`).style.width = `${percentage}%`;
                document.getElementById(`dynamic${capitalize(modality)}Value`).textContent = value.toFixed(3);
            });
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Display decomposed queries
        function displayDecomposedQueries(originalQuery, decomposedQueries) {
            if (!decomposedQueries) {
                decomposedQueriesDisplay.classList.remove('visible');
                return;
            }

            document.getElementById('originalQueryText').textContent = originalQuery;
            document.getElementById('visualQueryText').textContent = decomposedQueries.visual || originalQuery;
            document.getElementById('audioQueryText').textContent = decomposedQueries.audio || originalQuery;
            document.getElementById('transcriptionQueryText').textContent = decomposedQueries.transcription || originalQuery;
            decomposedQueriesDisplay.classList.add('visible');
            lastDecomposedQueries = decomposedQueries;
        }

        // Decomposition toggle event listener
        decompositionToggle.addEventListener('change', () => {
            useDecomposition = decompositionToggle.checked;

            if (!useDecomposition) {
                decomposedQueriesDisplay.classList.remove('visible');
            }

            if (searchInput.value.trim()) {
                performSearch();
            }
        });

        // All mode buttons (category pills)
        document.querySelectorAll('.category-pill').forEach(btn => {
            btn.addEventListener('click', () => {
                if (!btn.dataset.mode) return;

                document.querySelectorAll('.category-pill').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentMode = btn.dataset.mode;

                updatePanelVisibility();

                if (searchInput.value.trim()) {
                    performSearch();
                }
            });
        });

        // Weight sliders with debounced search
        let sliderDebounceTimer = null;
        ['visual', 'audio', 'transcription'].forEach(type => {
            const slider = document.getElementById(`${type}Weight`);
            const value = document.getElementById(`${type}Value`);

            slider.addEventListener('input', () => {
                value.textContent = (slider.value / 100).toFixed(2);

                clearTimeout(sliderDebounceTimer);
                sliderDebounceTimer = setTimeout(() => {
                    if (searchInput.value.trim() && currentMode === 'weighted') {
                        performSearch();
                    }
                }, 500);
            });
        });

        // Search
        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });

        async function performSearch() {
            const query = searchInput.value.trim();

            if (!query && !currentImageBase64) {
                alert('Please enter a search query or upload an image');
                return;
            }

            resultsContainer.innerHTML = '<div class="loading"><div class="spinner"></div><span>Searching...</span></div>';

            if (query && currentImageBase64) {
                queryDisplay.textContent = `${query} + Image`;
            } else if (currentImageBase64) {
                queryDisplay.textContent = 'Image Search';
            } else {
                queryDisplay.textContent = query;
            }

            resultsCount.textContent = '';

            try {
                let results;
                let responseData = {};

                if (currentMode === 'dynamic') {
                    const request = {
                        query: query || '',
                        query_image: currentImageBase64,
                        limit: 20,
                        backend: selectedBackend,
                        use_multi_index: useMultiIndex,
                        use_decomposition: useDecomposition
                    };
                    const response = await fetch('/api/search/dynamic', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(request)
                    });

                    if (!response.ok) throw new Error('Search failed');

                    responseData = await response.json();
                    results = responseData.results;
                    updateDynamicWeightsDisplay(responseData.computed_weights);

                    if (responseData.decomposed_queries) {
                        displayDecomposedQueries(query, responseData.decomposed_queries);
                    } else {
                        decomposedQueriesDisplay.classList.remove('visible');
                    }

                } else if (MULTI_VECTOR_MODES.includes(currentMode)) {
                    const request = {
                        query: query || '',
                        query_image: currentImageBase64,
                        limit: 20,
                        fusion_method: currentMode === 'rrf' ? 'rrf' : 'weighted',
                        backend: selectedBackend,
                        use_multi_index: useMultiIndex,
                        use_decomposition: DECOMPOSITION_MODES.includes(currentMode) && useDecomposition
                    };

                    if (currentMode === 'weighted') {
                        const visualW = document.getElementById('visualWeight').value / 100;
                        const audioW = document.getElementById('audioWeight').value / 100;
                        const transW = document.getElementById('transcriptionWeight').value / 100;

                        request.weights = {
                            visual: visualW,
                            audio: audioW,
                            transcription: transW
                        };
                    } else if (currentMode === 'fused') {
                        request.weights = {
                            visual: 0.8,
                            audio: 0.1,
                            transcription: 0.05
                        };
                    }

                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(request)
                    });

                    if (!response.ok) throw new Error('Search failed');
                    responseData = await response.json();
                    results = responseData.results;

                    if (responseData.decomposed_queries) {
                        displayDecomposedQueries(query, responseData.decomposed_queries);
                    } else {
                        decomposedQueriesDisplay.classList.remove('visible');
                    }

                } else {
                    const request = {
                        query: query || '',
                        query_image: currentImageBase64,
                        limit: 20,
                        modalities: [currentMode],
                        fusion_method: 'weighted',
                        backend: selectedBackend,
                        use_multi_index: useMultiIndex
                    };

                    const response = await fetch('/api/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(request)
                    });

                    if (!response.ok) throw new Error('Search failed');
                    responseData = await response.json();
                    results = responseData.results;

                    decomposedQueriesDisplay.classList.remove('visible');
                }

                currentResults = results || responseData.results;
                renderResults(results);

                storeSearchData(query, results, responseData);

                showCodeBtn.classList.add('visible');

                if (results.length > 0 && results[0].video_url) {
                    preloadedVideoUrl = results[0].video_url;
                }
            } catch (error) {
                console.error('Search error:', error);
                resultsContainer.innerHTML = `
                    <div class="empty-state">
                        <p>Search failed. Please try again.</p>
                    </div>
                `;
            }
        }

        // Store search data for code inspection
        function storeSearchData(query, results, responseData) {
            searchInputData = {
                mode: currentMode,
                query: query,
                backend: selectedBackend,
                use_multi_index: useMultiIndex,
                fusion_method: currentMode === 'rrf' ? 'rrf' : 'weighted',
                query_embeddings: responseData?.query_embeddings || null,
                decomposed_queries: responseData?.decomposed_queries || null,
                weights: {},
                parameters: {}
            };

            if (currentMode === 'fused') {
                searchInputData.weights = { visual: 0.8, audio: 0.1, transcription: 0.05 };
            } else if (currentMode === 'weighted') {
                searchInputData.weights = {
                    visual: parseFloat(document.getElementById('visualWeight').value) / 100,
                    audio: parseFloat(document.getElementById('audioWeight').value) / 100,
                    transcription: parseFloat(document.getElementById('transcriptionWeight').value) / 100
                };
            } else if (currentMode === 'dynamic') {
                searchInputData.weights = responseData?.computed_weights || lastDynamicWeights;
                searchInputData.anchor_similarities = responseData?.anchor_similarities;
                searchInputData.parameters.alpha = 10;
            } else if (currentMode === 'rrf') {
                searchInputData.parameters.k = 60;
            }

            searchInputData.parameters.top_k = 20;
            searchInputData.parameters.limit = 20;

            searchOutputData = {
                results: results.map(r => ({
                    segment_id: r.segment_id,
                    video_id: r.video_id,
                    start_time: r.start_time,
                    end_time: r.end_time,
                    s3_uri: r.s3_uri,
                    result_embeddings: r.embedding || null,
                    scores: {
                        ...r.modality_scores,
                        final: r.fusion_score
                    },
                    ranks: r.modality_ranks || null,
                    metadata: {
                        video_url: r.video_url,
                        thumbnail_url: r.thumbnail_url
                    }
                })),
                total_results: results.length,
                search_time_ms: responseData?.search_time_ms || null,
                backend: useMultiIndex ? 's3_vectors' : 'mongodb'
            };
        }

        function renderResults(results) {
            const modeLabel = getModeLabel(currentMode);
            resultsCount.textContent = `${results.length} results (${modeLabel})`;

            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="empty-state">
                        <p>No results found for this query.</p>
                    </div>
                `;
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'results-grid';

            results.forEach((result, index) => {
                const card = document.createElement('div');
                card.className = 'result-card';
                card.onclick = () => openVideo(result);

                const startTime = formatTime(result.start_time);
                const endTime = formatTime(result.end_time);

                const filename = result.s3_uri.split('/').pop() || 'Video';

                const modalityScores = result.modality_scores || {};
                const modalityTags = Object.entries(modalityScores)
                    .map(([mod, score]) => `<span class="meta-tag ${mod}">${mod.substring(0, 3)}: ${score.toFixed(2)}</span>`)
                    .join('');

                let dominantModality = null;
                let maxScore = 0;
                for (const [mod, score] of Object.entries(modalityScores)) {
                    if (score > maxScore) {
                        maxScore = score;
                        dominantModality = mod;
                    }
                }

                const maxPossibleScore = Math.max(...Object.values(modalityScores), 0.001);
                const modalityBars = ['visual', 'audio', 'transcription'].map(mod => {
                    const score = modalityScores[mod] || 0;
                    const width = (score / maxPossibleScore * 100).toFixed(1);
                    return `<div class="modality-bar"><div class="modality-bar-fill ${mod}" style="width: ${width}%"></div></div>`;
                }).join('');

                const showDominant = MULTI_VECTOR_MODES.includes(currentMode) && dominantModality;
                const dominantIndicator = showDominant
                    ? `<span class="dominant-indicator ${dominantModality}">${dominantModality.substring(0, 3)}</span>`
                    : '';

                const rank = index + 1;
                const confidenceScore = result.confidence_score !== undefined ? result.confidence_score : result.fusion_score;
                const confidencePercent = Math.round(confidenceScore * 100);

                card.innerHTML = `
                    <div class="thumbnail-container">
                        <div class="thumbnail-placeholder" id="placeholder-${index}">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                        </div>
                        <video
                            class="thumbnail-video"
                            muted
                            preload="metadata"
                            data-start="${result.start_time}"
                            data-index="${index}"
                            crossorigin="anonymous"
                        >
                            <source src="${result.video_url}" type="video/mp4">
                        </video>
                        <div class="play-overlay">
                            <svg viewBox="0 0 24 24" fill="white">
                                <polygon points="5 3 19 12 5 21 5 3"></polygon>
                            </svg>
                        </div>
                        <span class="rank-badge">#${rank}</span>
                        <span class="confidence-badge">
                            <span class="confidence-value">${confidencePercent}%</span>
                        </span>
                        ${dominantIndicator}
                        <span class="duration-badge">${startTime} - ${endTime}</span>
                    </div>
                    <div class="card-info">
                        <div class="card-title">${filename}</div>
                        <div class="card-subtitle">Segment ${result.segment_id} &middot; ${startTime} - ${endTime}</div>
                        <div class="card-meta">
                            ${modalityTags}
                        </div>
                        <div class="modality-bars">
                            ${modalityBars}
                        </div>
                    </div>
                `;

                grid.appendChild(card);
            });

            resultsContainer.innerHTML = '';
            resultsContainer.appendChild(grid);

            initializeThumbnails();
        }

        function getModeLabel(mode) {
            const labels = {
                'fused': 'Fused Embeddings',
                'rrf': 'RRF Fusion',
                'weighted': 'Weighted Fusion',
                'dynamic': 'Dynamic Routing',
                'visual': 'Visual Only',
                'audio': 'Audio Only',
                'transcription': 'Speech Only'
            };
            return labels[mode] || mode;
        }

        function initializeThumbnails() {
            const videos = document.querySelectorAll('.thumbnail-video');

            videos.forEach(video => {
                const startTime = parseFloat(video.dataset.start);
                const index = video.dataset.index;
                const placeholder = document.getElementById(`placeholder-${index}`);

                video.addEventListener('loadedmetadata', () => {
                    video.currentTime = startTime;
                });

                video.addEventListener('seeked', () => {
                    if (placeholder) {
                        placeholder.classList.add('hidden');
                    }
                });

                video.addEventListener('error', () => {
                    console.log('Video thumbnail failed to load');
                });
            });
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function openVideo(result) {
            if (!result.video_url) {
                alert('Video URL not available');
                return;
            }

            videoPlayer.src = result.video_url;

            videoPlayer.addEventListener('loadedmetadata', function onLoaded() {
                videoPlayer.currentTime = result.start_time;
                videoPlayer.removeEventListener('loadedmetadata', onLoaded);
            });

            const filename = result.s3_uri.split('/').pop() || 'Video';
            modalTitle.textContent = `${filename} - ${formatTime(result.start_time)}`;

            const modalityScoresHtml = Object.entries(result.modality_scores || {})
                .map(([mod, score]) => `<span class="meta-tag ${mod}">${mod}: ${score.toFixed(4)}</span>`)
                .join('');

            const confidenceScore = result.confidence_score !== undefined ? result.confidence_score : result.fusion_score;
            const confidencePercent = Math.round(confidenceScore * 100);

            modalInfo.innerHTML = `
                <span class="meta-tag">Segment: ${result.segment_id}</span>
                <span class="meta-tag">Time: ${formatTime(result.start_time)} - ${formatTime(result.end_time)}</span>
                <span class="meta-tag">Confidence: ${confidencePercent}% (${confidenceScore.toFixed(4)})</span>
                <span class="meta-tag">Fusion: ${result.fusion_score.toFixed(4)}</span>
                ${modalityScoresHtml}
            `;

            videoModal.classList.add('active');
            videoPlayer.play().catch(e => console.log('Autoplay prevented:', e));
        }

        // Close modal
        modalClose.addEventListener('click', closeModal);
        videoModal.addEventListener('click', (e) => {
            if (e.target === videoModal) closeModal();
        });

        function closeModal() {
            videoModal.classList.remove('active');
            videoPlayer.pause();
            videoPlayer.src = '';
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeCodeModal();
                searchOptionsPanel.classList.remove('open');
                filterBtn.classList.remove('active');
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('sidebar-mobile-open');
                }
            }
            if (e.key === '/' && document.activeElement !== searchInput) {
                e.preventDefault();
                searchInput.focus();
            }
        });

        // =============================================
        // Code Inspection Feature
        // =============================================
        let searchInputData = null;
        let searchOutputData = null;

        const codeInspectionModal = document.getElementById('codeInspectionModal');
        const showCodeBtn = document.getElementById('showCodeBtn');
        const codeModalClose = document.getElementById('codeModalClose');
        const copyCodeBtn = document.getElementById('copyCodeBtn');
        const exportCodeBtn = document.getElementById('exportCodeBtn');
        const inputPanel = document.getElementById('inputPanel');
        const outputPanel = document.getElementById('outputPanel');
        const inputCode = document.getElementById('inputCode');
        const outputCode = document.getElementById('outputCode');

        // Tab switching
        document.querySelectorAll('.code-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;

                document.querySelectorAll('.code-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                document.querySelectorAll('.code-panel').forEach(p => p.classList.remove('active'));
                document.getElementById(`${tabName}Panel`).classList.add('active');
            });
        });

        // Show code modal
        showCodeBtn.addEventListener('click', () => {
            if (searchInputData && searchOutputData) {
                displayCodeInspection();
                codeInspectionModal.classList.add('active');
            }
        });

        // Close code modal
        codeModalClose.addEventListener('click', closeCodeModal);
        codeInspectionModal.addEventListener('click', (e) => {
            if (e.target === codeInspectionModal) closeCodeModal();
        });

        function closeCodeModal() {
            codeInspectionModal.classList.remove('active');
        }

        // Copy JSON to clipboard
        copyCodeBtn.addEventListener('click', async () => {
            const activeTab = document.querySelector('.code-tab.active').dataset.tab;
            const jsonData = activeTab === 'input' ? searchInputData : searchOutputData;

            try {
                await navigator.clipboard.writeText(JSON.stringify(jsonData, null, 2));
                copyCodeBtn.textContent = 'Copied!';
                setTimeout(() => {
                    copyCodeBtn.textContent = 'Copy JSON';
                }, 2000);
            } catch (err) {
                console.error('Failed to copy:', err);
            }
        });

        // Export JSON file
        exportCodeBtn.addEventListener('click', () => {
            const combined = {
                input: searchInputData,
                output: searchOutputData,
                timestamp: new Date().toISOString(),
                mode: currentMode
            };

            const blob = new Blob([JSON.stringify(combined, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `search_results_${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Format JSON with syntax highlighting
        function formatJSON(json) {
            const jsonStr = JSON.stringify(json, null, 2);
            return jsonStr
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"([^"]+)":/g, '<span class="json-key">"$1"</span>:')
                .replace(/: "([^"]*)"/g, ': <span class="json-string">"$1"</span>')
                .replace(/: (-?\d+\.?\d*)/g, ': <span class="json-number">$1</span>')
                .replace(/: (true|false)/g, ': <span class="json-boolean">$1</span>')
                .replace(/: (null)/g, ': <span class="json-null">$1</span>');
        }

        // Display code inspection
        function displayCodeInspection() {
            inputCode.innerHTML = formatJSON(searchInputData);
            outputCode.innerHTML = formatJSON(searchOutputData);
        }

        // =============================================
        // Backend and Index Mode Controls
        // =============================================
        const backendDropdown = document.getElementById('backendDropdown');
        const indexModeToggle = document.getElementById('indexModeToggle');
        const indexModeIndicator = document.getElementById('indexModeIndicator');
        let selectedBackend = 's3vectors';
        let useMultiIndex = true;

        // Check backend availability on load
        async function checkBackendAvailability() {
            try {
                const response = await fetch('/api/index-mode');
                if (!response.ok) return;

                const data = await response.json();

                if (!data.s3_vectors_available) {
                    selectedBackend = 'mongodb';
                    backendDropdown.value = 'mongodb';
                    useMultiIndex = false;
                    indexModeToggle.checked = false;
                    indexModeToggle.disabled = false;
                    updateIndexModeIndicator();
                    console.log('S3 Vectors not available, defaulting to MongoDB (unified-index, toggle enabled)');
                } else {
                    selectedBackend = 's3vectors';
                    backendDropdown.value = 's3vectors';
                    useMultiIndex = true;
                    indexModeToggle.checked = true;
                    indexModeToggle.disabled = false;
                    updateIndexModeIndicator();
                    console.log('S3 Vectors available, defaulting to multi-index mode (toggle enabled)');
                }
            } catch (error) {
                console.log('Backend availability check failed:', error);
            }
        }

        // Handle backend dropdown change
        backendDropdown.addEventListener('change', () => {
            selectedBackend = backendDropdown.value;

            if (selectedBackend === 'mongodb') {
                useMultiIndex = false;
                indexModeToggle.checked = false;
                indexModeToggle.disabled = false;
                updateIndexModeIndicator();
            } else {
                useMultiIndex = true;
                indexModeToggle.checked = true;
                indexModeToggle.disabled = false;
                updateIndexModeIndicator();
            }

            if (searchInput.value.trim()) {
                performSearch();
            }
        });

        // Handle index mode toggle change
        indexModeToggle.addEventListener('change', () => {
            useMultiIndex = indexModeToggle.checked;
            updateIndexModeIndicator();

            if (searchInput.value.trim()) {
                performSearch();
            }
        });

        // Update index mode indicator text
        function updateIndexModeIndicator() {
            indexModeIndicator.textContent = useMultiIndex ? 'Multi-Index' : 'Unified-Index';
        }

        // Initialize on page load
        checkBackendAvailability();
        updatePanelVisibility(); // Disable decomposition toggle on initial load

        // =============================================
        // Sidebar Navigation — Page Switching
        // =============================================
        function switchToPage(page) {
            const homeView = document.getElementById('homeView');
            const analyzeView = document.getElementById('analyzeView');
            const indexesView = document.getElementById('indexesView');
            const pillsRow = document.querySelector('.category-pills-row');

            // Hide all views
            homeView.style.display = 'none';
            analyzeView.style.display = 'none';
            indexesView.style.display = 'none';

            // Show target view + control pills visibility
            if (page === 'analyze') {
                analyzeView.style.display = 'flex';
                pillsRow.style.display = 'none';
                analyzeFolderState = 'folders';
                loadAnalyzeFolders();
            } else if (page === 'indexes') {
                indexesView.style.display = 'block';
                pillsRow.style.display = 'none';
                // Always reset to root folder view
                document.getElementById('indexesListView').style.display = 'block';
                document.getElementById('indexesDetailView').style.display = 'none';
                document.getElementById('indexesBreadcrumb').innerHTML =
                    '<span class="indexes-breadcrumb-current">Indexes</span>';
                loadIndexCounts();
            } else {
                homeView.style.display = 'block';
                pillsRow.style.display = 'flex';
            }

            // Update sidebar active state
            document.querySelectorAll('.sidebar-nav-item[data-page]').forEach(i => i.classList.remove('active'));
            const target = document.querySelector(`.sidebar-nav-item[data-page="${page}"]`);
            if (target) target.classList.add('active');
        }

        document.querySelectorAll('.sidebar-nav-item[data-page]').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const page = item.dataset.page;

                switchToPage(page);

                // Home — clear search and reset
                if (page === 'home') {
                    searchInput.value = '';
                    resultsContainer.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg><p>Enter a search query to find video segments</p></div>';
                    queryDisplay.textContent = '';
                    resultsCount.textContent = '';
                    currentResults = [];
                    decomposedQueriesDisplay.classList.remove('visible');
                    // Reset dynamic weight bars
                    lastDynamicWeights = null;
                    ['visual', 'audio', 'transcription'].forEach(m => {
                        document.getElementById(`dynamic${capitalize(m)}Bar`).style.width = '0%';
                        document.getElementById(`dynamic${capitalize(m)}Value`).textContent = '-';
                    });
                    // Clear image attachment
                    currentImageBase64 = null;
                    imageUpload.value = '';
                    imagePreview.classList.remove('active');
                    imagePreview.style.display = 'none';
                    previewImg.src = '';
                }

                // Examples — cycle through preset queries and search
                if (page === 'examples') {
                    // Clear image attachment before running example
                    currentImageBase64 = null;
                    imageUpload.value = '';
                    imagePreview.classList.remove('active');
                    imagePreview.style.display = 'none';
                    previewImg.src = '';
                    decomposedQueriesDisplay.classList.remove('visible');
                    const query = EXAMPLE_QUERIES[exampleQueryIndex];
                    exampleQueryIndex = (exampleQueryIndex + 1) % EXAMPLE_QUERIES.length;
                    searchInput.value = query;
                    performSearch();
                }
            });
        });

        // =============================================
        // Indexes Page
        // =============================================
        let indexCountsLoaded = false;

        async function loadIndexCounts() {
            if (indexCountsLoaded) return;
            indexCountsLoaded = true;

            const combos = [
                { backend: 'mongodb', mode: 'unified', el: 'countMongoUnified' },
                { backend: 'mongodb', mode: 'multi', el: 'countMongoMulti' },
                { backend: 's3vectors', mode: 'unified', el: 'countS3Unified' },
                { backend: 's3vectors', mode: 'multi', el: 'countS3Multi' },
            ];
            for (const c of combos) {
                fetch(`/api/indexes/${c.backend}/${c.mode}/videos`)
                    .then(r => r.json())
                    .then(videos => {
                        document.getElementById(c.el).textContent = `${videos.length} videos`;
                    })
                    .catch(() => {
                        document.getElementById(c.el).textContent = 'unavailable';
                    });
            }
        }

        // Open folder → video list
        document.querySelectorAll('.index-card').forEach(card => {
            card.addEventListener('click', () => {
                const backend = card.dataset.backend;
                const mode = card.dataset.mode;
                openIndex(backend, mode);
            });
        });

        function openIndex(backend, mode) {
            document.getElementById('indexesListView').style.display = 'none';
            document.getElementById('indexesDetailView').style.display = 'block';
            updateIndexBreadcrumb(backend, mode);

            const grid = document.getElementById('indexesVideoGrid');
            grid.innerHTML = '<div style="color: var(--text-tertiary); padding: 20px;">Loading videos...</div>';

            fetch(`/api/indexes/${backend}/${mode}/videos`)
                .then(r => r.json())
                .then(videos => renderIndexVideos(videos))
                .catch(() => {
                    grid.innerHTML = '<div style="color: var(--text-tertiary); padding: 20px;">Failed to load videos.</div>';
                });
        }

        function renderIndexVideos(videos) {
            const grid = document.getElementById('indexesVideoGrid');
            if (!videos.length) {
                grid.innerHTML = '<div style="color: var(--text-tertiary); padding: 20px;">No videos in this index.</div>';
                return;
            }
            grid.innerHTML = videos.map(v => {
                const displayName = v.name || v.video_id;
                return `
                <div class="index-video-card" data-video-url="${v.video_url || ''}" data-name="${displayName}">
                    <video class="index-video-thumb" src="${v.video_url || ''}" muted preload="metadata"></video>
                    <div class="index-video-info">
                        <div class="index-video-name" title="${displayName}">${displayName}</div>
                        <div class="index-video-segments">${v.segment_count || 0} segments</div>
                    </div>
                </div>
            `}).join('');

            grid.querySelectorAll('.index-video-card').forEach(card => {
                const thumb = card.querySelector('.index-video-thumb');
                thumb.addEventListener('loadedmetadata', () => {
                    // Seek to a random frame (between 10% and 80% of duration)
                    if (thumb.duration && thumb.duration > 0) {
                        const minT = thumb.duration * 0.1;
                        const maxT = thumb.duration * 0.8;
                        thumb.currentTime = minT + Math.random() * (maxT - minT);
                    }
                });
                card.addEventListener('click', () => {
                    openVideoModal(card.dataset.videoUrl, card.dataset.name);
                });
            });
        }

        function openVideoModal(url, title) {
            const player = document.getElementById('videoPlayer');
            const modal = document.getElementById('videoModal');
            const modalTitle = document.getElementById('modalTitle');
            player.src = url;
            modalTitle.textContent = title || 'Video Playback';
            modal.classList.add('active');
            player.play();
        }

        function updateIndexBreadcrumb(backend, mode) {
            const label = backend === 'mongodb'
                ? `MongoDB — ${mode === 'unified' ? 'Unified' : 'Multi'}`
                : `S3 Vectors — ${mode === 'unified' ? 'Unified' : 'Multi'}`;
            document.getElementById('indexesBreadcrumb').innerHTML = `
                <span class="indexes-breadcrumb-link" onclick="closeIndexDetail()">Indexes</span>
                <span class="indexes-breadcrumb-separator">&rsaquo;</span>
                <span class="indexes-breadcrumb-current">${label}</span>
            `;
        }

        function closeIndexDetail() {
            document.getElementById('indexesListView').style.display = 'block';
            document.getElementById('indexesDetailView').style.display = 'none';
            document.getElementById('indexesBreadcrumb').innerHTML =
                '<span class="indexes-breadcrumb-current">Indexes</span>';
        }

        // =============================================
        // Analyze Page
        // =============================================
        let analyzeSelectedVideo = null;
        let analyzeFolderState = 'folders';
        let analyzeCurrentBackend = null;
        let analyzeCurrentMode = null;

        const ANALYZE_FOLDERS = [
            { backend: 's3vectors', mode: 'multi', name: 'S3 Vectors — Multi', meta: 'Multi-index, per modality' },
            { backend: 's3vectors', mode: 'unified', name: 'S3 Vectors — Unified', meta: 'Single-index, all modalities' },
            { backend: 'mongodb', mode: 'multi', name: 'MongoDB — Multi', meta: 'Multi-index, per modality' },
            { backend: 'mongodb', mode: 'unified', name: 'MongoDB — Unified', meta: 'Single-index, all modalities' },
        ];

        function loadAnalyzeFolders() {
            if (analyzeFolderState === 'videos') return; // Already viewing videos
            analyzeFolderState = 'folders';
            document.getElementById('analyzeSidebarTitle').textContent = 'Select Asset';
            const list = document.getElementById('analyzeAssetList');
            list.innerHTML = ANALYZE_FOLDERS.map(f => `
                <div class="analyze-folder-item" data-backend="${f.backend}" data-mode="${f.mode}">
                    <div class="analyze-folder-icon">
                        <svg width="16" height="16" viewBox="0 0 12 10" fill="currentColor">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M11 8.66667V2.58333C11 2.39924 10.8508 2.25 10.6667 2.25H6.41756C5.9418 2.25 5.47741 2.10457 5.08664 1.8332L3.97257 1.05954C3.91675 1.02078 3.85041 1 3.78244 1H1.33333C1.14924 1 1 1.14924 1 1.33333V8.66667C1 8.85076 1.14924 9 1.33333 9H10.6667C10.8508 9 11 8.85076 11 8.66667ZM12 8.66667V2.58333C12 1.84695 11.403 1.25 10.6667 1.25H6.41756C6.1457 1.25 5.88033 1.1669 5.65703 1.01183L4.54297 0.238173C4.31967 0.0831044 4.0543 0 3.78244 0H1.33333C0.596955 0 0 0.596954 0 1.33333V8.66667C0 9.40305 0.596954 10 1.33333 10H10.6667C11.403 10 12 9.40305 12 8.66667Z"/>
                        </svg>
                    </div>
                    <div class="analyze-folder-info">
                        <span class="analyze-folder-name">${f.name}</span>
                        <span class="analyze-folder-count">loading...</span>
                    </div>
                </div>
            `).join('');

            // Fetch counts
            list.querySelectorAll('.analyze-folder-item').forEach(item => {
                const backend = item.dataset.backend;
                const mode = item.dataset.mode;
                fetch(`/api/indexes/${backend}/${mode}/videos`)
                    .then(r => r.json())
                    .then(videos => {
                        item.querySelector('.analyze-folder-count').textContent = `${videos.length} videos`;
                    })
                    .catch(() => {
                        item.querySelector('.analyze-folder-count').textContent = 'unavailable';
                    });

                item.addEventListener('click', () => openAnalyzeFolder(backend, mode));
            });
        }

        function openAnalyzeFolder(backend, mode) {
            analyzeFolderState = 'videos';
            analyzeCurrentBackend = backend;
            analyzeCurrentMode = mode;

            const folderName = ANALYZE_FOLDERS.find(f => f.backend === backend && f.mode === mode)?.name || 'Index';
            document.getElementById('analyzeSidebarTitle').textContent = folderName;

            const list = document.getElementById('analyzeAssetList');
            list.innerHTML = '<div style="color: var(--text-tertiary); padding: 12px;">Loading...</div>';

            fetch(`/api/indexes/${backend}/${mode}/videos`)
                .then(r => r.json())
                .then(videos => {
                    list.innerHTML = `
                        <div class="analyze-back-btn" id="analyzeBackBtn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                            All Indexes
                        </div>
                    ` + videos.map(v => {
                        const name = v.name || v.video_id;
                        return `
                        <div class="analyze-video-item" data-video-id="${v.video_id}" data-video-url="${v.video_url || ''}" data-name="${name}" data-segments="${v.segment_count || 0}">
                            <video class="analyze-video-thumb" src="${v.video_url || ''}" muted preload="metadata"></video>
                            <span class="analyze-video-name" title="${name}">${name}</span>
                        </div>`;
                    }).join('');

                    // Back button
                    document.getElementById('analyzeBackBtn').addEventListener('click', () => {
                        analyzeFolderState = 'folders';
                        loadAnalyzeFolders();
                    });

                    // Video thumbnails: seek to random frame
                    list.querySelectorAll('.analyze-video-thumb').forEach(thumb => {
                        thumb.addEventListener('loadedmetadata', () => {
                            if (thumb.duration > 0) {
                                thumb.currentTime = thumb.duration * (0.1 + Math.random() * 0.7);
                            }
                        });
                    });

                    // Video selection
                    list.querySelectorAll('.analyze-video-item').forEach(item => {
                        item.addEventListener('click', () => {
                            // Remove previous active
                            list.querySelectorAll('.analyze-video-item.active').forEach(a => a.classList.remove('active'));
                            item.classList.add('active');

                            selectAnalyzeVideo({
                                video_id: item.dataset.videoId,
                                video_url: item.dataset.videoUrl,
                                name: item.dataset.name,
                                segment_count: item.dataset.segments
                            });
                        });
                    });
                })
                .catch(() => {
                    list.innerHTML = '<div style="color: var(--text-tertiary); padding: 12px;">Failed to load videos.</div>';
                });
        }

        function selectAnalyzeVideo(video) {
            analyzeSelectedVideo = video;

            // Show preview bar
            const previewEl = document.getElementById('analyzePreview');
            previewEl.style.display = 'flex';

            const previewVideo = document.getElementById('analyzePreviewVideo');
            previewVideo.src = video.video_url;
            previewVideo.addEventListener('loadedmetadata', () => {
                if (previewVideo.duration > 0) {
                    previewVideo.currentTime = previewVideo.duration * 0.3;
                }
            }, { once: true });

            document.getElementById('analyzePreviewName').textContent = video.name;
            document.getElementById('analyzePreviewMeta').textContent = `${video.segment_count} segments`;

            // Update placeholder
            document.getElementById('analyzeInput').placeholder = `Chat with ${video.name}...`;
            document.getElementById('analyzeInput').focus();
        }

        function clearAnalyzeVideo() {
            analyzeSelectedVideo = null;

            // Hide preview bar
            document.getElementById('analyzePreview').style.display = 'none';

            // Remove active state from sidebar
            document.querySelectorAll('.analyze-video-item.active').forEach(a => a.classList.remove('active'));

            // Reset placeholder
            document.getElementById('analyzeInput').placeholder = 'Chat with your videos...';
        }

        async function performAnalyzeSearch() {
            const query = document.getElementById('analyzeInput').value.trim();
            if (!query) return;

            const resultsEl = document.getElementById('analyzeResults');
            resultsEl.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%;"><div class="loading"><div class="spinner"></div><span>Searching...</span></div></div>';

            const body = {
                query: query,
                limit: 20,
                backend: analyzeCurrentBackend || 's3vectors',
                use_multi_index: analyzeCurrentMode !== 'unified',
                use_decomposition: false
            };

            // Filter to specific video if one is selected
            if (analyzeSelectedVideo) {
                body.video_id = analyzeSelectedVideo.video_id;
            }

            try {
                const response = await fetch('/api/search/dynamic', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!response.ok) throw new Error('Search failed');

                const data = await response.json();
                renderAnalyzeResults(data.results || []);
            } catch (err) {
                console.error('Analyze search error:', err);
                resultsEl.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-tertiary);"><p>Search failed. Please try again.</p></div>';
            }
        }

        function renderAnalyzeResults(results) {
            const resultsEl = document.getElementById('analyzeResults');
            if (!results.length) {
                resultsEl.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-tertiary);"><p>No results found.</p></div>';
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'analyze-results-grid';

            results.forEach(r => {
                const startTime = formatTime(r.start_time);
                const endTime = formatTime(r.end_time);
                const confidence = Math.round((r.confidence_score !== undefined ? r.confidence_score : r.fusion_score) * 100);

                const card = document.createElement('div');
                card.className = 'analyze-result-card';
                card.innerHTML = `
                    <div class="analyze-result-thumb-wrap">
                        <video muted preload="metadata" data-start="${r.start_time}">
                            <source src="${r.video_url}" type="video/mp4">
                        </video>
                        <span class="analyze-result-confidence">${confidence}%</span>
                        <span class="analyze-result-badge">${startTime} - ${endTime}</span>
                    </div>
                    <div class="analyze-result-info">
                        <div class="analyze-result-title">Segment ${r.segment_id}</div>
                    </div>
                `;

                // Thumbnail: seek to segment start + 1s
                const thumb = card.querySelector('video');
                thumb.addEventListener('loadedmetadata', () => {
                    thumb.currentTime = r.start_time + 1;
                });

                // Click → open modal
                card.addEventListener('click', () => {
                    const videoName = analyzeSelectedVideo ? analyzeSelectedVideo.name : `Segment ${r.segment_id}`;
                    openVideoModal(r.video_url + '#t=' + r.start_time, videoName);
                });

                grid.appendChild(card);
            });

            resultsEl.innerHTML = '';
            resultsEl.appendChild(grid);
        }

        // Analyze event listeners
        document.getElementById('analyzeSendBtn').addEventListener('click', performAnalyzeSearch);
        document.getElementById('analyzeInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') performAnalyzeSearch();
        });
        document.getElementById('analyzeClearVideo').addEventListener('click', clearAnalyzeVideo);

        // Search from Indexes/Analyze page → switch to Home with results
        const origPerformSearch = performSearch;
        // Wrap search to ensure we're on Home view
        const searchInputEl = document.getElementById('searchInput');
        const searchBtnEl = document.getElementById('searchBtn');

        function ensureHomeBeforeSearch() {
            const indexesView = document.getElementById('indexesView');
            const analyzeView = document.getElementById('analyzeView');
            if (indexesView.style.display !== 'none' || analyzeView.style.display !== 'none') {
                switchToPage('home');
                // Don't clear search since we want to execute it
            }
        }

        searchBtnEl.addEventListener('click', ensureHomeBeforeSearch, true);
        searchInputEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') ensureHomeBeforeSearch();
        }, true);
    </script>
</body>
</html>
